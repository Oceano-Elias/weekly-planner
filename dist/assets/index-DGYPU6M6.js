(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function s(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=s(i);fetch(i.href,a)}})();const G="/weekly-planner/icon.png",b={SLOT_DURATION:30,CELL_HEIGHT:52,DEFAULT_DURATION:60,MIN_DURATION:15,MAX_DURATION:480,START_HOUR:8,END_HOUR:19,MAX_DEPT_LEVELS:4,DAYS:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],DAY_LABELS:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],getWeekStart(e){const t=new Date(e),s=t.getDay(),n=t.getDate()-s+(s===0?-6:1),i=new Date(t.setDate(n));return i.setHours(0,0,0,0),i},getWeekDays(e){return Array.from({length:7},(t,s)=>{const n=new Date(e);return n.setDate(e.getDate()+s),n})},formatDate(e){const t=new Date(e),s=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${s}-${n}-${i}`},formatDuration(e){if(e<60)return`${e}m`;const t=Math.floor(e/60),s=e%60;return s>0?`${t}h ${s}m`:`${t}h`},isSlotAvailable(e,t,s,n=null){const[i,a]=e.split(":").map(Number),o=i*60+a,r=o+t,l=this.START_HOUR*60,c=this.END_HOUR*60;if(o<l||r>c)return!1;for(const h of s){if(h.id===n||!h.scheduledTime)continue;const[m,g]=h.scheduledTime.split(":").map(Number),u=m*60+g,f=u+h.duration;if(o<f&&r>u)return!1}return!0},getWeekKey(e){const t=new Date(e),s=t.getDay(),n=t.getDate()-s+(s===0?-6:1),i=new Date(t.setDate(n));return i.setHours(0,0,0,0),i.toISOString().split("T")[0]},escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},throttle(e,t){let s;return function(){const n=arguments,i=this;s||(e.apply(i,n),s=!0,setTimeout(()=>s=!1,t))}}},U="weeklyPlanner_v3";let d={tasks:[],nextId:1,currentWeekStart:null,templates:[],weeklyInstances:{},migrated:!1,weeklyData:{},defaultTemplate:null,goals:{},activeExecution:{taskId:null,sessionStartTime:null,accumulatedTime:0,running:!1,phase:"orientation",mode:"work",breakStartTime:null,returnAnchor:"",currentStepIndex:-1,updatedAt:null}},W=[],O=null;const p={getState(){return d},reset(){d={tasks:[],nextId:1,currentWeekStart:null,templates:[],weeklyInstances:{},migrated:!1,weeklyData:{},defaultTemplate:null,goals:{},activeExecution:{taskId:null,sessionStartTime:null,accumulatedTime:0,running:!1,phase:"orientation",mode:"work",breakStartTime:null,returnAnchor:"",currentStepIndex:-1,updatedAt:null}},W=[]},init(){this.load(),!d.migrated&&d.tasks.length>0&&(console.log("Running migration on init..."),this.migrateToWeeklySystem()),this.setCurrentWeek(new Date),this.notify()},subscribe(e){return W.push(e),()=>{W=W.filter(t=>t!==e)}},notify(){W.forEach(e=>{try{e()}catch(t){console.error("Error in store listener:",t)}})},load(){try{const e=localStorage.getItem(U);if(e){const t=JSON.parse(e);d.tasks=t.tasks||[],d.nextId=t.nextId||1,d.weeklyData=t.weeklyData||{},d.defaultTemplate=t.defaultTemplate||null,d.goals=t.goals||{},d.templates=t.templates||[],d.weeklyInstances=t.weeklyInstances||{},d.migrated=t.migrated||!1}this.migrateToWeeklySystem()}catch(e){console.error("Error loading from storage:",e)}},save(e=!1){O&&clearTimeout(O);const t=()=>{try{localStorage.setItem(U,JSON.stringify({tasks:d.tasks,nextId:d.nextId,weeklyData:d.weeklyData,defaultTemplate:d.defaultTemplate,goals:d.goals,templates:d.templates,weeklyInstances:d.weeklyInstances,migrated:d.migrated})),console.log("[Store] Changes persisted to localStorage")}catch(s){console.error("Error saving to storage:",s)}};e?t():O=setTimeout(t,1e3)},setCurrentWeek(e){d.currentWeekStart=b.getWeekStart(e),this.notify()},getCurrentWeekKey(){return b.getWeekKey(d.currentWeekStart)},addTask({title:e,goal:t="",hierarchy:s,duration:n,notes:i=""}){const a={id:`task_${d.nextId++}`,title:e,goal:t,hierarchy:s,duration:n,notes:i,completed:!1,scheduledDay:null,scheduledTime:null,createdAt:Date.now()};return d.tasks.push(a),this.save(),this.notify(),a},updateTask(e,t){const s=this._resolveTask(e);return s?(s.type==="legacy"?Object.assign(s.task,t):s.type==="week_standalone"?Object.assign(s.instance,t):s.type==="template"&&(Object.assign(s.template,t),t.completed!==void 0&&(s.instance.completed=t.completed),t.notes!==void 0&&(s.instance.notes=t.notes),t.returnAnchor!==void 0&&(s.instance.returnAnchor=t.returnAnchor)),this.save(),this.notify(),this.getTask(e)):null},deleteTask(e){const t=this._resolveTask(e);if(t){if(t.type==="legacy")d.tasks=d.tasks.filter(s=>s.id!==e);else if(t.type==="week_standalone"||t.type==="template"){const s=d.weeklyInstances[t.weekId];s&&(s.tasks=s.tasks.filter(n=>t.type==="week_standalone"&&n.instanceId!==t.instance.instanceId||t.type==="template"&&n.templateId!==t.templateId))}this.save(),this.notify()}},getTask(e){if(!e)return null;const t=this._resolveTask(e);return t?t.type==="template"?{...t.template,id:e,completed:t.instance.completed,notes:t.instance.notes,returnAnchor:t.instance.returnAnchor||"",scheduledDay:t.instance.scheduledDay||t.template.scheduledDay,scheduledTime:t.instance.scheduledTime||t.template.scheduledTime}:t.type==="week_standalone"?{id:e,...t.instance}:t.task:null},_resolveTask(e){if(!e.includes("_")||!e.startsWith("week_")&&!e.startsWith("template_")){const t=d.tasks.find(s=>s.id===e);return t?{type:"legacy",task:t}:null}if(e.startsWith("week_")){const t=e.split("_"),s=t[1],n=d.weeklyInstances[s];if(!n)return null;const i=t.slice(2).join("_");let a=null;if(i.startsWith("inst_"))a=n.tasks.find(o=>o.instanceId===i);else if(i.startsWith("idx_")||i.startsWith("task_")){const o=parseInt(i.split("_")[1]);a=n.tasks[o]}return a?{type:"week_standalone",instance:a,weekId:s}:null}if(e.startsWith("template_")){const t=e.split("_"),s=t[t.length-1],n=t.slice(0,-1).join("_"),i=d.templates.find(r=>r.id===n),a=d.weeklyInstances[s];if(!i||!a)return null;const o=a.tasks.find(r=>r.templateId===n);return o?{type:"template",template:i,instance:o,weekId:s,templateId:n}:null}return null},getQueueTasks(){return d.tasks.filter(e=>!e.scheduledDay)},getScheduledTasks(){return d.tasks.filter(e=>e.scheduledDay&&e.scheduledTime)},getAllTasks(){return d.tasks},getTasksForDay(e){const t=this.getWeekIdentifier(d.currentWeekStart||new Date);return this.getTasksForWeek(t).filter(n=>n.scheduledDay===e)},scheduleTask(e,t,s,n=!1){const i=d.tasks.find(l=>l.id===e);if(!i)return null;i.scheduledDay=t,i.scheduledTime=s;const a=this.getWeekIdentifier(d.currentWeekStart||new Date);d.weeklyInstances[a]||(d.weeklyInstances[a]={tasks:[]});const o=d.weeklyInstances[a].tasks;let r=o.find(l=>l.sourceTaskId===e);return r||(r=o.find(l=>l.title===i.title)),r?(console.log(`[Store] Updating existing instance for task: ${i.title} to ${t} ${s}`),r.scheduledDay=t,r.scheduledTime=s,r.duration=i.duration,r.hierarchy=[...i.hierarchy||[]],r.goal=i.goal||"",r.notes=i.notes||"",r.sourceTaskId||(r.sourceTaskId=e)):(console.log(`[Store] Creating new instance for task: ${i.title} on ${t} ${s}`),d.weeklyInstances[a].tasks.push({instanceId:`inst_${d.nextId++}`,templateId:null,sourceTaskId:e,title:i.title,goal:i.goal||"",hierarchy:[...i.hierarchy||[]],duration:i.duration,completed:!1,notes:i.notes||"",scheduledDay:t,scheduledTime:s})),this.save(n),this.notify(),i},rescheduleTaskInWeek(e,t,s){if(!e)return null;if(e.startsWith("task_"))return this.scheduleTask(e,t,s,!0);if(e.startsWith("week_")){const n=e.split("_"),i=n[1],a=d.weeklyInstances[i];if(!a)return null;const o=n.slice(2).join("_");let r=null;if(o.startsWith("inst_"))r=a.tasks.find(l=>l.instanceId===o);else if(o.startsWith("idx_")||o.startsWith("task_")){const l=parseInt(o.split("_")[1]);r=a.tasks[l]}return r?(console.log(`[Store] Rescheduling week-standalone instance ${e} to ${t} ${s}`),r.scheduledDay=t,r.scheduledTime=s,this.save(!0),this.notify(),this.getTask(e)):(console.warn(`[Store] Week instance not found for ID: ${e}`),null)}if(e.split("_").length>=3){const n=e.split("_"),i=n[n.length-1],a=n.slice(0,-1).join("_"),o=d.weeklyInstances[i];if(!o)return null;const r=o.tasks.find(l=>l.templateId===a);if(r)return console.log(`[Store] Rescheduling template instance ${e} to ${t} ${s}`),r.scheduledDay=t,r.scheduledTime=s,this.save(!0),this.notify(),this.getTask(e);console.warn(`[Store] Template instance not found for ID: ${e}`)}return null},unscheduleTask(e,t=!1){const s=this._resolveTask(e);if(!s)return null;let n=null;if(s.type==="legacy")s.task.scheduledDay=null,s.task.scheduledTime=null,n=s.task;else{const i=s.type==="template"?s.template:s.instance;n={id:`task_${d.nextId++}`,title:i.title,goal:i.goal||"",hierarchy:[...i.hierarchy||[]],duration:i.duration,notes:i.notes||"",completed:!1,scheduledDay:null,scheduledTime:null,createdAt:Date.now()},d.tasks.push(n);const a=d.weeklyInstances[s.weekId];a&&(a.tasks=a.tasks.filter(o=>s.type==="week_standalone"&&o.instanceId!==s.instance.instanceId||s.type==="template"&&o.templateId!==s.templateId)),s.type==="template"&&(d.templates=d.templates.filter(o=>o.id!==s.templateId))}return this.save(t),this.notify(),n},toggleComplete(e){const t=d.tasks.find(s=>s.id===e);return t&&(t.completed=!t.completed,this.save(),this.notify()),t},getGoals(){return d.goals||{}},saveGoal(e,t){d.goals||(d.goals={}),d.goals[e]=t,this.save(),this.notify()},setDefaultTemplate(e,t){d.defaultTemplate={scheduled:e.map(s=>({title:s.title,goal:s.goal||"",hierarchy:[...s.hierarchy],duration:s.duration,notes:s.notes||"",scheduledDay:s.scheduledDay,scheduledTime:s.scheduledTime})),queue:t.map(s=>({title:s.title,goal:s.goal||"",hierarchy:[...s.hierarchy],duration:s.duration,notes:s.notes||""}))},this.save()},setTemplateFromCurrentWeek(){const e=this.getWeekIdentifier(d.currentWeekStart||new Date),t=this.getTasksForWeek(e);d.templates=[],t.forEach(n=>{const i=`template_${d.nextId++}`;d.templates.push({id:i,title:n.title,goal:n.goal||"",hierarchy:[...n.hierarchy],duration:n.duration,notes:n.notes||"",scheduledDay:n.scheduledDay,scheduledTime:n.scheduledTime})}),Object.keys(d.weeklyInstances).forEach(n=>{n!==e&&delete d.weeklyInstances[n]}),this.save()},getTemplateCount(){return d.templates.length},resetWeekToTemplate(){const e=this.getWeekIdentifier(d.currentWeekStart||new Date);this.createWeekFromTemplate(e),this.notify()},getWeekIdentifier(e){const t=b.getWeekStart(e),s=t.getFullYear(),n=Math.ceil(((t-new Date(s,0,1))/864e5+1)/7);return`${s}-W${String(n).padStart(2,"0")}`},hasWeekInstances(e){return!!d.weeklyInstances[e]},createWeekFromTemplate(e){if(!d.templates||d.templates.length===0){d.weeklyInstances[e]={tasks:[]},this.save();return}d.weeklyInstances[e]={tasks:d.templates.map(t=>({templateId:t.id,completed:!1,notes:t.notes||"",scheduledDay:t.scheduledDay,scheduledTime:t.scheduledTime}))},this.save()},getTasksForWeek(e){return this.hasWeekInstances(e)||this.createWeekFromTemplate(e),(d.weeklyInstances[e]?.tasks||[]).map((s,n)=>{if(s.templateId){const i=d.templates.find(a=>a.id===s.templateId);return i?{...i,id:`${i.id}_${e}`,completed:s.completed,notes:s.notes,scheduledDay:s.scheduledDay||i.scheduledDay,scheduledTime:s.scheduledTime||i.scheduledTime}:null}else{const i=s.instanceId||`idx_${n}`;return{id:`week_${e}_${i}`,title:s.title,goal:s.goal||"",hierarchy:s.hierarchy||[],duration:s.duration,completed:s.completed,notes:s.notes,scheduledDay:s.scheduledDay,scheduledTime:s.scheduledTime}}}).filter(Boolean)},migrateToWeeklySystem(){if(d.migrated)return;console.log("Migrating to per-week system...");const e=d.tasks.filter(s=>s.scheduledDay&&s.scheduledTime);d.templates=e.map((s,n)=>({id:`template_${d.nextId+n}`,title:s.title,goal:s.goal||"",hierarchy:[...s.hierarchy],duration:s.duration,scheduledDay:s.scheduledDay,scheduledTime:s.scheduledTime})),d.nextId+=e.length;const t=this.getWeekIdentifier(d.currentWeekStart||new Date);d.weeklyInstances[t]={tasks:d.templates.map(s=>{const n=e.find(i=>i.title===s.title&&i.scheduledDay===s.scheduledDay&&i.scheduledTime===s.scheduledTime);return{templateId:s.id,completed:n?.completed||!1,notes:n?.notes||"",scheduledDay:s.scheduledDay,scheduledTime:s.scheduledTime}})},d.migrated=!0,this.save(),console.log(`Migration complete. Created ${d.templates.length} templates.`)},toggleCompleteForWeek(e){if(!e)return null;if(!e.includes("_"))return this.toggleComplete(e);if(e.startsWith("week_")){const s=e.split("_"),n=s[1],i=d.weeklyInstances[n];if(!i)return null;const a=s.slice(2).join("_");let o=null;if(a.startsWith("inst_"))o=i.tasks.find(r=>r.instanceId===a);else if(a.startsWith("idx_")||a.startsWith("task_")){const r=parseInt(a.split("_")[1]);o=i.tasks[r]}return o?(o.completed=!o.completed,this.save(),this.notify(),o):null}const t=e.split("_");if(t.length>=3){const s=t[t.length-1],n=t.slice(0,-1).join("_"),i=d.weeklyInstances[s];if(i){const a=i.tasks.find(o=>o.templateId===n);if(a)return a.completed=!a.completed,this.save(),this.notify(),a}}return null},advanceTaskProgress(e){const t=this.getTask(e);if(!t)return null;let s=!1,n=t.notes||"";const i=n.split(`
`),a=i.findIndex(o=>o.includes("[ ]"));return a!==-1?(i[a]=i[a].replace("[ ]","[x]"),n=i.join(`
`),this.updateTaskNotesForWeek(e,n),s=!0,!i.some(r=>r.includes("[ ]"))&&!t.completed&&this.toggleCompleteForWeek(e)):this.toggleCompleteForWeek(e),{task:this.getTask(e),stepAdvanced:s}},updateTaskNotesForWeek(e,t){if(!e)return null;if(!e.includes("_")){const s=d.tasks.find(n=>n.id===e);return s&&(s.notes=t,this.save()),s}if(e.startsWith("week_")){const s=e.split("_"),n=s[1],i=d.weeklyInstances[n];if(!i)return null;const a=s.slice(2).join("_");let o=null;if(a.startsWith("inst_"))o=i.tasks.find(r=>r.instanceId===a);else if(a.startsWith("idx_")||a.startsWith("task_")){const r=parseInt(a.split("_")[1]);o=i.tasks[r]}return o?(o.notes=t,this.save(),this.notify(),o):null}if(e.split("_").length>=3){const s=e.split("_"),n=s[s.length-1],i=s.slice(0,-1).join("_"),a=d.weeklyInstances[n];if(!a)return null;const o=a.tasks.find(r=>r.templateId===i);if(o)return o.notes=t,this.save(),this.notify(),o}return null},getAnalytics(){const e=this.getScheduledTasks(),t={};return e.forEach(s=>{const n=s.hierarchy[0]||"Uncategorized";t[n]||(t[n]={total:0,completed:0}),t[n].total+=s.duration,s.completed&&(t[n].completed+=s.duration)}),t},getAnalyticsForWeek(){const e=this.getWeekIdentifier(d.currentWeekStart||new Date),t=this.getTasksForWeek(e),s={};let n=0,i=0,a=t.length,o=0,r=0,l=0;return t.forEach(c=>{const h=c.hierarchy[0]||"Uncategorized";s[h]||(s[h]={total:0,completed:0}),s[h].total+=c.duration,r+=c.duration,c.completed&&(s[h].completed+=c.duration,o++,l+=c.duration),c.notes&&c.notes.split(`
`).filter(g=>g.trim()!=="").forEach(g=>{(g.includes("[ ]")||g.includes("[x]"))&&(n++,g.includes("[x]")&&i++)})}),{byHierarchy:s,miniTasks:{total:n,completed:i},tasks:{total:a,completed:o},duration:{total:r,completed:l}}},getDailyStatsForWeek(){const e=this.getWeekIdentifier(d.currentWeekStart||new Date),t=this.getTasksForWeek(e);return["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].map(n=>{const i=t.filter(m=>m.scheduledDay===n),a=i.length,o=i.filter(m=>m.completed).length,r=a>0?Math.round(o/a*100):0;let l=0,c=0;i.forEach(m=>{m.notes&&m.notes.split(`
`).filter(u=>u.trim()!=="").forEach(u=>{(u.includes("[ ]")||u.includes("[x]"))&&(l++,u.includes("[x]")&&c++)})});const h=l>0?Math.round(c/l*100):0;return{day:n.charAt(0).toUpperCase()+n.slice(1,3),tasks:{total:a,completed:o,percent:r},miniTasks:{total:l,completed:c,percent:h}}})},getCustomDepartments(){try{const e=localStorage.getItem("weeklyPlanner_departments");if(e)return JSON.parse(e)}catch(e){console.error("Error loading custom departments:",e)}return null},saveCustomDepartments(e){try{localStorage.setItem("weeklyPlanner_departments",JSON.stringify(e)),window.dispatchEvent(new CustomEvent("departmentsUpdated",{detail:e}))}catch(t){console.error("Error saving custom departments:",t)}},resetDepartmentsToDefaults(){localStorage.removeItem("weeklyPlanner_departments"),window.dispatchEvent(new CustomEvent("departmentsUpdated",{detail:null}))},migrateDepartment(e,t){const s=n=>{if(!n||!e.every((o,r)=>n[r]===o))return n;if(t===null)return[];const a=n.slice(e.length);return[...t,...a]};d.tasks.forEach(n=>{n.hierarchy=s(n.hierarchy)}),d.templates.forEach(n=>{n.hierarchy=s(n.hierarchy)}),Object.values(d.weeklyInstances).forEach(n=>{n.tasks&&n.tasks.forEach(i=>{i.hierarchy=s(i.hierarchy)})}),this.save()},exportData(){return{version:"3.0",exportedAt:new Date().toISOString(),data:{tasks:d.tasks,templates:d.templates,weeklyInstances:d.weeklyInstances,goals:d.goals,nextId:d.nextId,migrated:d.migrated}}},downloadExport(){const e=this.exportData(),t=JSON.stringify(e,null,2),s=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(s),i=document.createElement("a");i.href=n,i.download=`weekly-planner-backup-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n)},importData(e,t=!1){try{if(!e||!e.data)throw new Error("Invalid data format");const{data:s}=e,n=a=>typeof a!="string"?a:b.escapeHtml(a),i=a=>({...a,title:n(a.title),goal:n(a.goal),notes:n(a.notes),hierarchy:Array.isArray(a.hierarchy)?a.hierarchy.map(n):[]});return t?(s.tasks&&s.tasks.forEach(a=>{const o=i(a);o.id=`task_${d.nextId++}`,d.tasks.push(o)}),s.templates&&s.templates.forEach(a=>{const o=i(a);o.id=`template_${d.nextId++}`,d.templates.push(o)}),s.goals&&Object.keys(s.goals).forEach(a=>{d.goals[a]=n(s.goals[a])})):(d.tasks=(s.tasks||[]).map(i),d.templates=(s.templates||[]).map(i),d.weeklyInstances=s.weeklyInstances||{},d.goals=s.goals||{},d.nextId=s.nextId||1,d.migrated=s.migrated||!1,Object.values(d.weeklyInstances).forEach(a=>{a.tasks&&(a.tasks=a.tasks.map(i))})),this.save(!0),this.notify(),!0}catch(s){return console.error("Import failed:",s),!1}},async importFromFile(e,t=!1){return new Promise(s=>{const n=new FileReader;n.onload=i=>{try{const a=JSON.parse(i.target.result),o=this.importData(a,t);s(o)}catch(a){console.error("Failed to parse import file:",a),s(!1)}},n.onerror=()=>s(!1),n.readAsText(e)})},getActivePomodoro(){return d.activePomodoro},setActivePomodoro(e,t){d.activePomodoro={...d.activePomodoro,...t,taskId:e,updatedAt:Date.now()},this.save(),this.notify()},clearActivePomodoro(){d.activePomodoro={taskId:null,remainingSeconds:1500,targetEpoch:null,running:!1,mode:"work",updatedAt:Date.now()},this.save(),this.notify()}},X={WORK:{color:"#3B82F6",abbr:"W",children:{"Social Media":{abbr:"SM",children:{YouTube:{abbr:"YT",children:{Script:{abbr:"SC"},Filming:{abbr:"FM"},Editing:{abbr:"ED"},Thumbnail:{abbr:"TH"},Upload:{abbr:"UP"}}},Instagram:{abbr:"IG",children:{Reels:{abbr:"RL"},Stories:{abbr:"ST"},Posts:{abbr:"PO"},Captions:{abbr:"CP"}}},TikTok:{abbr:"TT",children:{Content:{abbr:"CT"},Trends:{abbr:"TR"}}},Twitter:{abbr:"TW",children:{Threads:{abbr:"TH"},Engagement:{abbr:"EG"}}}}},Projects:{abbr:"PJ",children:{"Project Alpha":{abbr:"PA"},"Project Beta":{abbr:"PB"},"Project Gamma":{abbr:"PG"}}},Meetings:{abbr:"MT",children:{"Team Sync":{abbr:"TS"},"Client Call":{abbr:"CC"},"One-on-One":{abbr:"1:1"}}},Admin:{abbr:"AD",children:{Email:{abbr:"EM"},Planning:{abbr:"PL"},Reports:{abbr:"RP"}}}}},PERSONAL:{color:"#10B981",abbr:"P",children:{Home:{abbr:"HM",children:{Cleaning:{abbr:"CL"},Cooking:{abbr:"CK"},Maintenance:{abbr:"MN"},Shopping:{abbr:"SH"}}},Family:{abbr:"FM",children:{Kids:{abbr:"KD"},Partner:{abbr:"PT"},Parents:{abbr:"PR"}}},Social:{abbr:"SC",children:{Friends:{abbr:"FR"},Events:{abbr:"EV"}}}}},HEALTH:{color:"#F59E0B",abbr:"H",children:{Fitness:{abbr:"FT",children:{Gym:{abbr:"GY"},Running:{abbr:"RN"},Yoga:{abbr:"YG"},Swimming:{abbr:"SW"}}},Medical:{abbr:"MD",children:{"Doctor Visits":{abbr:"DV"},Dental:{abbr:"DN"},Therapy:{abbr:"TH"}}},Wellness:{abbr:"WL",children:{Meditation:{abbr:"MT"},Sleep:{abbr:"SL"},Nutrition:{abbr:"NT"}}}}},LEARNING:{color:"#8B5CF6",abbr:"L",children:{Courses:{abbr:"CR",children:{Online:{abbr:"ON"},"In-Person":{abbr:"IP"},Workshops:{abbr:"WS"}}},Reading:{abbr:"RD",children:{Books:{abbr:"BK"},Articles:{abbr:"AR"},Research:{abbr:"RS"}}},Practice:{abbr:"PR",children:{Coding:{abbr:"CD"},Design:{abbr:"DS"},Writing:{abbr:"WR"}}}}},FINANCE:{color:"#EC4899",abbr:"F",children:{Budgeting:{abbr:"BD",children:{"Monthly Review":{abbr:"MR"},"Expense Tracking":{abbr:"ET"}}},Investing:{abbr:"IV",children:{Research:{abbr:"RS"},"Portfolio Review":{abbr:"PR"}}},Bills:{abbr:"BL",children:{Utilities:{abbr:"UT"},Subscriptions:{abbr:"SB"}}}}},ADMIN:{color:"#6366F1",abbr:"A",children:{Documents:{abbr:"DC",children:{Filing:{abbr:"FL"},Scanning:{abbr:"SC"}}},"Life Admin":{abbr:"LA",children:{Appointments:{abbr:"AP"},Errands:{abbr:"ER"},"Phone Calls":{abbr:"PC"}}}}}};function q(){try{const e=localStorage.getItem("weeklyPlanner_departments");if(e)return JSON.parse(e)}catch(e){console.error("Error loading custom departments:",e)}return X}let B=q();function J(){B=q()}typeof window<"u"&&window.addEventListener("departmentsUpdated",()=>{B=q()});const C={getTopLevel(){return Object.keys(B)},get(e){return B[e]},getColor(e){if(!e||e.length===0)return"#666";const t=e[0];return B[t]?.color||"#666"},getAbbreviation(e){if(!e||e.length===0)return"";let t=B,s="";for(let n=0;n<e.length;n++){const i=e[n];n===0?t=t[i]:t=t?.children?.[i],t?.abbr&&(s=t.abbr)}return s},getRootAbbreviation(e){if(!e||e.length===0)return"";const t=e[0];return B[t]?.abbr||""},getChildren(e){if(!e||e.length===0)return Object.keys(B);let t=B;for(let s=0;s<e.length;s++){const n=e[s];if(s===0?t=t[n]:t=t?.children?.[n],!t)return[]}return t?.children?Object.keys(t.children):[]},hasChildren(e){return this.getChildren(e).length>0},formatPath(e,t=" â€º "){return!e||e.length===0?"":e.join(t)},getTree(){const e=(t,s=[])=>{const n=[];for(const[i,a]of Object.entries(t)){const o=[...s,i],r={name:i,path:o,color:s.length===0?a.color:null,abbr:a.abbr,children:a.children?e(a.children,o):[]};n.push(r)}return n};return e(B)}};class z{constructor(t){this.task=t}getStepCounts(){const n=(this.task.notes||"").split(`
`).filter(a=>a.trim()).filter(a=>a.includes("[ ]")||a.includes("[x]"));return{completed:n.filter(a=>a.includes("[x]")).length,total:n.length}}render({isDayView:t=!1,isCompact:s=!1}={}){const n=this.task,i=C.getColor(n.hierarchy),a=C.getRootAbbreviation(n.hierarchy),o=n.hierarchy[0]||"",r=n.hierarchy.slice(1).join(" â€º "),l=document.createElement("div"),c=n.duration>=45&&n.duration<90,h=n.duration>=90;l.className=`glass-surface glass-surface-hover task-block ${n.completed?"completed":""} ${t?"day-view":""} ${s?"layout-compact":c?"layout-standard":h?"layout-full":""}`,l.dataset.taskId=n.id,l.draggable=!0,l.style.setProperty("--task-color",i);const m=b.escapeHtml,{completed:g,total:u}=this.getStepCounts(),f=u>0?g/u*100:0,y=u>0&&g===u,v=y?"âœ“ Complete":`${g}/${u} steps`,T=y?"complete":"",S=u>0?`<span class="task-step-progress ${T}">
           <span class="step-fill" style="width: ${f}%"></span>
           <span class="step-text">${v}</span>
         </span>`:"",x=`
      <div class="task-header task-header-row">
        <div class="task-header-left">
          <span class="task-dept-badge" style="background-color: ${i};">${a}</span>
          <span class="task-title">${m(n.title)}</span>
        </div>
        ${t?S:""}
        <div class="task-duration">
          <span>${b.formatDuration(n.duration)}</span>
        </div>
      </div>
    `;let k="";if(!t&&u>0)k=`
        <div class="task-progress-row ${s?"compact":""}">
          <span class="task-step-progress full-width ${T}">
            <span class="step-fill" style="width: ${f}%"></span>
            <span class="step-text">${v}</span>
          </span>
        </div>
      `;else if(t&&n.duration>=60&&(o||r)){const w=[o,...n.hierarchy.slice(1)].filter(Boolean).join(" â€º ");k=`<div class="task-hierarchy-row">${m(w)}</div>`}return l.innerHTML=`
      <button class="task-delete" title="Delete">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
      ${x}
      ${k}
    `,l}}const H={show(e,t=null,s="Confirm"){return new Promise(n=>{const i=document.createElement("div");i.className="confirm-overlay";const a=document.createElement("div");a.className="confirm-modal",a.setAttribute("role","alertdialog"),a.setAttribute("aria-modal","true"),a.setAttribute("aria-labelledby","confirmMessage");const r=s.toLowerCase()==="delete"?"confirm-btn confirm-delete":"confirm-btn confirm-ok";a.innerHTML=`
                <div class="confirm-content">
                    <p class="confirm-message" id="confirmMessage">${e}</p>
                    <div class="confirm-buttons">
                        <button class="confirm-btn confirm-cancel">Cancel</button>
                        <button class="${r}">${s}</button>
                    </div>
                </div>
            `,i.appendChild(a),document.body.appendChild(i),setTimeout(()=>{const u=a.querySelector(".confirm-ok, .confirm-delete");u&&u.focus()},100);const l=a.querySelector(".confirm-cancel"),c=()=>{document.body.removeChild(i),document.removeEventListener("keydown",m),n(!1)};l.addEventListener("click",c),i.addEventListener("click",u=>{u.target===i&&c()});const h=a.querySelector(".confirm-ok, .confirm-delete");h.addEventListener("click",()=>{document.body.removeChild(i),document.removeEventListener("keydown",m),t&&t(),n(!0)});const m=u=>{u.key==="Escape"&&c()};document.addEventListener("keydown",m);const g=u=>{if(u.key!=="Tab")return;const f=[l,h],y=f[0],v=f[f.length-1];u.shiftKey&&document.activeElement===y?(u.preventDefault(),v.focus()):!u.shiftKey&&document.activeElement===v&&(u.preventDefault(),y.focus())};a.addEventListener("keydown",g)})}},I={currentWeekStart:null,get days(){return b.DAYS},get dayLabels(){return b.DAY_LABELS},get startHour(){return b.START_HOUR},get endHour(){return b.END_HOUR},viewMode:"week",selectedDayIndex:0,progressTimer:null,gridClickHandler:null,onEditTask:null,onOpenModalWithSchedule:null,onPlayCompletionAnimation:null,setViewMode(e){if(this.viewMode=e,e==="day"&&(this.selectedDayIndex===null||this.selectedDayIndex===void 0)){const s=this.getWeekDates().findIndex(n=>this.isToday(n));this.selectedDayIndex=s!==-1?s:0}this.renderHeader(),this.renderGrid()},init(){this.setCurrentWeek(new Date),this.renderHeader(),this.renderGrid(),this.setupNavigation(),this.setupViewToggle(),this.setupProgressTimer()},setCurrentWeek(e){this.currentWeekStart=b.getWeekStart(e),p.setCurrentWeek(this.currentWeekStart);const t=p.getWeekIdentifier(this.currentWeekStart);p.hasWeekInstances(t)||(console.log(`Auto-generating week ${t} from template...`),p.createWeekFromTemplate(t))},getWeekDates(){const e=[];for(let t=0;t<7;t++){const s=new Date(this.currentWeekStart);s.setDate(s.getDate()+t),e.push(s)}return e},formatWeekDisplay(){const e=this.getWeekDates();if(this.viewMode==="day")return e[this.selectedDayIndex].toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric",year:"numeric"});const t=e[0],s=e[6],n={month:"long",day:"numeric"},i=t.toLocaleDateString("en-US",n),a=s.toLocaleDateString("en-US",{...n,year:"numeric"});return`${i} - ${a}`},isToday(e){const t=new Date;return e.toDateString()===t.toDateString()},renderHeader(){const e=document.getElementById("calendarHeader"),t=this.getWeekDates(),s=p.getGoals();let n='<div class="calendar-header-cell"></div>';if(this.viewMode==="week")t.forEach((i,a)=>{const o=this.isToday(i),r=this.days[a],l=s[r]||"";n+=`
          <div class="calendar-header-cell day-header-nav" data-index="${a}">
            <div class="calendar-day-name">${this.dayLabels[a]}</div>
            <div class="calendar-day-date ${o?"today":""}">${i.getDate()}</div>
            <input type="text" class="calendar-day-goal" 
                   placeholder="Add goal..." 
                   data-day="${r}"
                   value="${l.replace(/"/g,"&quot;")}">
          </div>
        `}),e.style.gridTemplateColumns="var(--calendar-time-col, 60px) repeat(7, 1fr)";else{const i=this.selectedDayIndex,a=t[i],o=this.isToday(a),r=this.days[i],l=s[r]||"",c=a.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}),m=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});n+=`
        <div class="calendar-header-cell day-view-header-new">
          <div class="day-header-left">
            <span class="day-header-date ${o?"today":""}">${c}</span>
          </div>
          <div class="day-header-center">
            <input type="text" class="day-header-goal" 
                   placeholder="ðŸŽ¯ Set today's goal..." 
                   data-day="${r}"
                   value="${l.replace(/"/g,"&quot;")}">
          </div>
          <div class="day-header-right">
            <span class="day-header-clock" id="dayHeaderClock">${m}</span>
          </div>
        </div>
      `,e.style.gridTemplateColumns="var(--calendar-time-col, 60px) 1fr",this.startDayClockTimer()}e.innerHTML=n,document.getElementById("weekDisplay").textContent=this.formatWeekDisplay(),this.setupGoalListeners(),this.setupHeaderNavigation()},setupHeaderNavigation(){document.getElementById("calendarHeader").querySelectorAll(".day-header-nav").forEach(t=>{t.addEventListener("click",s=>{if(s.target.tagName==="INPUT")return;const n=parseInt(t.dataset.index);this.selectedDayIndex=n,this.setViewMode("day"),document.querySelectorAll(".view-btn").forEach(i=>{i.classList.toggle("active",i.dataset.view==="day")})})})},setupGoalListeners(){document.querySelectorAll(".calendar-day-goal, .day-header-goal").forEach(t=>{t.addEventListener("change",s=>{const n=s.target.dataset.day,i=s.target.value;p.saveGoal(n,i)})})},getTimeSlots(){const e=[];for(let t=this.startHour;t<this.endHour;t++)e.push({hour:t,minute:0,label:this.formatTime(t,0)}),e.push({hour:t,minute:30,label:""});return e},formatTime(e,t){const s=e.toString().padStart(2,"0"),n=t.toString().padStart(2,"0");return`${s}:${n}`},renderGrid(){const e=document.getElementById("calendarGrid"),t=this.getTimeSlots();let s='<div class="time-column">';t.forEach(o=>{s+=`<div class="time-slot-label">${o.label}</div>`}),s+="</div>";let n="";const i=this.viewMode==="week"?this.days:[this.days[this.selectedDayIndex]],a=this.getWeekDates();i.forEach((o,r)=>{const l=this.viewMode==="week"?r:this.selectedDayIndex,c=a[l]&&this.isToday(a[l]);n+=`<div class="day-column ${c?"today":""}" data-day="${o}">`,t.forEach(h=>{const m=this.formatTime(h.hour,h.minute);n+=`<div class="calendar-cell" data-day="${o}" data-time="${m}"></div>`}),n+="</div>"}),e.innerHTML=s+n,this.viewMode==="week"?e.style.gridTemplateColumns="var(--calendar-time-col, 60px) repeat(7, 1fr)":e.style.gridTemplateColumns="var(--calendar-time-col, 60px) 1fr",this.renderScheduledTasks(),this.setupCellClick(),this.updateTimeMarker()},renderScheduledTasks(){const e=p.getWeekIdentifier(this.currentWeekStart);let t=p.getTasksForWeek(e);document.querySelectorAll(".calendar-task").forEach(s=>s.remove()),window.Filters&&(t=t.filter(s=>window.Filters.selectedPaths.length===0||!s.hierarchy||s.hierarchy.length===0?!0:window.Filters.selectedPaths.some(n=>n.length>s.hierarchy.length?!1:n.every((i,a)=>s.hierarchy[a]===i)))),t.forEach(s=>{this.renderTask(s)})},renderTask(e){if(!e.scheduledDay||!e.scheduledTime)return;const t=document.querySelector(`.day-column[data-day="${e.scheduledDay}"]`);if(!t)return;const[s,n]=e.scheduledTime.split(":").map(Number),i=(s-this.startHour)*2+(n>=b.SLOT_DURATION?1:0),a=e.duration/b.SLOT_DURATION,o=b.CELL_HEIGHT,r=i*o+1,l=a*o-2,c=document.createElement("div"),h=e.duration<=b.SLOT_DURATION;c.className=`calendar-task ${e.completed?"completed":""} ${h?"compact":""}`,c.style.top=`${r}px`,c.style.height=`${l}px`;const g=new z(e).render({isDayView:this.viewMode==="day",isCompact:h});if(g.draggable=!1,c.appendChild(g),!e.completed){const y=document.createElement("div");y.className="task-progress-overlay",c.appendChild(y)}t.appendChild(c),this.updateTaskProgress(c,e);const u=c.querySelector(".task-block"),f=c.querySelector(".task-delete");u.addEventListener("click",()=>{window.lastClickedTaskId=e.id}),u.addEventListener("dblclick",y=>{y.stopPropagation(),this.onEditTask?this.onEditTask(e.id):window.App&&window.App.editTask&&window.App.editTask(e.id)}),u.addEventListener("contextmenu",y=>{y.preventDefault(),y.stopPropagation();const v=p.getTask(e.id),T=v?v.completed:!1,S=v&&v.notes&&v.notes.includes("[ ]");v&&!T&&!S&&(this.onPlayCompletionAnimation?this.onPlayCompletionAnimation(c):window.App&&window.App.playCompletionAnimation&&window.App.playCompletionAnimation(c));const x=p.advanceTaskProgress(e.id),k=x?x.task:null;if(x&&x.stepAdvanced,!T&&k&&k.completed&&window.Confetti){const w=u.getBoundingClientRect(),D=w.left+w.width/2,M=w.top+w.height/2;window.Confetti.burst(D,M,40),S&&(this.onPlayCompletionAnimation?this.onPlayCompletionAnimation(c):window.App&&window.App.playCompletionAnimation&&window.App.playCompletionAnimation(c))}!T&&k&&k.completed&&this.checkDailyCelebration(e.scheduledDay),k&&k.completed&&!T?setTimeout(()=>{this.renderScheduledTasks(),window.TaskQueue&&window.TaskQueue.refresh()},500):(this.renderScheduledTasks(),window.TaskQueue&&window.TaskQueue.refresh())}),f&&f.addEventListener("click",async y=>{y.preventDefault(),y.stopPropagation(),await H.show("Are you sure you want to delete this task?")&&(p.deleteTask(e.id),this.renderScheduledTasks(),window.TaskQueue&&window.TaskQueue.refresh(),window.Filters&&window.Filters.refresh())})},updateTaskProgress(e,t){if(t.completed)return;const s=e.querySelector(".task-progress-overlay");if(!s)return;const n=this.calculateProgress(t);if(s.classList.remove("in-progress","expired"),e.classList.remove("time-passed"),n<=0)s.style.height="0%";else if(n>=1)s.style.height="100%",s.classList.add("expired"),e.classList.add("time-passed");else{s.classList.add("in-progress");const i=n*100;s.style.height=`${i.toFixed(1)}%`}},calculateProgress(e){if(!e.scheduledDay||!e.scheduledTime)return 0;const t=this.getWeekDates(),s=this.days.indexOf(e.scheduledDay),n=t[s],i=new Date,a=new Date(n.getFullYear(),n.getMonth(),n.getDate()),o=new Date(i.getFullYear(),i.getMonth(),i.getDate());let r=0;if(a<o)r=1;else if(a>o)r=0;else{const[c,h]=e.scheduledTime.split(":").map(Number),m=new Date(i);m.setHours(c,h,0,0);const g=new Date(m);g.setMinutes(g.getMinutes()+e.duration),i<m?r=0:i>g?r=1:r=(i-m)/(g-m)}let l=0;if(e.notes){const h=e.notes.split(`
`).filter(m=>m.trim()).filter(m=>m.includes("[ ]")||m.includes("[x]"));h.length>0&&(l=h.filter(g=>g.includes("[x]")).length/h.length)}return Math.max(r,l)},setupProgressTimer(){this.progressTimer&&clearInterval(this.progressTimer),this.updateTimeMarker(),this.progressTimer=setInterval(()=>{document.querySelectorAll(".calendar-task").forEach(e=>{const t=e.querySelector(".task-block");if(!t)return;const s=t.dataset.taskId,n=p.getTask(s);n&&this.updateTaskProgress(e,n)}),this.updateTimeMarker()},1e4)},updateTimeMarker(){const e=document.getElementById("calendarGrid");if(!e)return;let t=document.getElementById("currentTimeMarker");const s=new Date,n=s.getHours();if(n<this.startHour||n>=this.endHour){t&&(t.style.display="none");return}const i=this.getWeekDates(),a=s.toDateString();let o=!1;if(this.viewMode==="week"?o=i.some(g=>g.toDateString()===a):o=i[this.selectedDayIndex].toDateString()===a,!o){t&&(t.style.display="none");return}t||(t=document.createElement("div"),t.id="currentTimeMarker",e.appendChild(t));const r=e.querySelector(".calendar-cell"),l=r?r.offsetHeight:50,h=((n-this.startHour)*60+s.getMinutes())/30*l,m=s.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});t.style.display="block",t.style.top=`${h}px`,t.setAttribute("data-time",m)},setupViewToggle(){const e=document.querySelectorAll(".view-btn");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(s=>s.classList.remove("active")),t.classList.add("active"),this.setViewMode(t.dataset.view)})})},setupNavigation(){document.getElementById("prevWeek").addEventListener("click",()=>{this.viewMode==="day"?this.selectedDayIndex>0?this.selectedDayIndex--:(this.currentWeekStart.setDate(this.currentWeekStart.getDate()-7),p.setCurrentWeek(this.currentWeekStart),this.selectedDayIndex=6):(this.currentWeekStart.setDate(this.currentWeekStart.getDate()-7),p.setCurrentWeek(this.currentWeekStart)),this.renderHeader(),this.renderGrid(),window.TaskQueue&&window.TaskQueue.refresh()}),document.getElementById("nextWeek").addEventListener("click",()=>{this.viewMode==="day"?this.selectedDayIndex<6?this.selectedDayIndex++:(this.currentWeekStart.setDate(this.currentWeekStart.getDate()+7),p.setCurrentWeek(this.currentWeekStart),this.selectedDayIndex=0):(this.currentWeekStart.setDate(this.currentWeekStart.getDate()+7),p.setCurrentWeek(this.currentWeekStart)),this.renderHeader(),this.renderGrid(),window.TaskQueue&&window.TaskQueue.refresh()}),document.getElementById("todayBtn").addEventListener("click",()=>{if(this.setCurrentWeek(new Date),this.viewMode==="day"){const t=this.getWeekDates().findIndex(s=>this.isToday(s));this.selectedDayIndex=t!==-1?t:0}this.renderHeader(),this.renderGrid(),window.TaskQueue&&window.TaskQueue.refresh()})},setupCellClick(){const e=document.getElementById("calendarGrid");e&&(this.gridClickHandler&&e.removeEventListener("click",this.gridClickHandler),this.gridClickHandler=t=>{const s=t.target.closest(".calendar-cell");if(!s||t.target.closest(".calendar-task")||t.target.closest(".task-block"))return;const n=s.dataset.day,i=s.dataset.time,a=this.getMaxDurationForSlot(n,i);this.onOpenModalWithSchedule?this.onOpenModalWithSchedule(n,i,a):window.App&&window.App.openModalWithSchedule&&window.App.openModalWithSchedule(n,i,a)},e.addEventListener("click",this.gridClickHandler))},getMaxDurationForSlot(e,t){const[s,n]=t.split(":").map(Number),i=s*60+n,a=this.endHour*60;if(i>=a)return 0;const o=p.getTasksForDay(e);let r=a;return o.forEach(l=>{if(!l.scheduledTime)return;const[c,h]=l.scheduledTime.split(":").map(Number),m=c*60+h,g=m+(l.duration||0);if(m<=i&&g>i){r=i;return}m>i&&m<r&&(r=m)}),Math.max(0,r-i)},refresh(){this.renderScheduledTasks(),this.setupCellClick()},dayClockTimer:null,startDayClockTimer(){this.dayClockTimer&&clearInterval(this.dayClockTimer),this.dayClockTimer=setInterval(()=>{const e=document.getElementById("dayHeaderClock");if(e){const s=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});e.textContent=s}else clearInterval(this.dayClockTimer),this.dayClockTimer=null},1e3)},checkDailyCelebration(e){const t=p.getWeekIdentifier(this.currentWeekStart),s=p.getTasksForWeek(t).filter(i=>i.scheduledDay===e);if(console.log("Checking celebration for",e,"- Tasks:",s.length,"Completed:",s.filter(i=>i.completed).length),s.length===0)return;const n=s.every(i=>i.completed);console.log("All complete?",n),n&&window.Confetti&&(console.log("ðŸŽŠ Triggering confetti celebration!"),setTimeout(()=>{window.Confetti.celebrate()},600))}},E={selectedDepts:[],selectedPaths:[],onFilterChange:null,init(){const e=C.getTopLevel();this.selectedDepts=[...e],this.selectedPaths=this.selectedDepts.map(t=>[t]),this.render(),p.subscribe(()=>{console.log("Filters: Store updated, refreshing task counts..."),this.refresh()})},render(){const e=document.getElementById("filterTree");if(!e)return;const t=C.getTopLevel();let s=`
      <div class="filter-header">
        <h3 class="filter-title">Filter by Department</h3>
        <div class="filter-actions">
          <button class="filter-action-btn" id="selectAllFilters">Select All</button>
          <button class="filter-action-btn" id="clearFilters">Clear All</button>
        </div>
      </div>
      <div class="filter-cards">
    `;t.forEach(n=>{const i=C.getColor([n]),a=this.selectedDepts.includes(n),o=this.getTaskCount(n);s+=`
        <div class="filter-card ${a?"selected":""}" 
             data-dept="${n}" 
             style="--dept-color: ${i}">
          <div class="filter-card-header">
            <span class="filter-card-color" style="background: ${i}"></span>
            <span class="filter-card-name">${n}</span>
          </div>
          <div class="filter-card-count">${o} task${o!==1?"s":""}</div>
          <div class="filter-card-check">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <path d="M5 13l4 4L19 7"/>
            </svg>
          </div>
        </div>
      `}),s+="</div>",e.innerHTML=s,this.setupListeners()},getTaskCount(e){return(p?p.getAllTasks():[]).filter(s=>s.hierarchy&&s.hierarchy[0]===e).length},setupListeners(){const e=this;document.querySelectorAll(".filter-card").forEach(n=>{n.addEventListener("click",()=>{const i=n.dataset.dept;e.selectedDepts.includes(i)?(e.selectedDepts=e.selectedDepts.filter(a=>a!==i),n.classList.remove("selected")):(e.selectedDepts.push(i),n.classList.add("selected")),e.selectedPaths=e.selectedDepts.map(a=>[a]),e.onFilterChange&&e.onFilterChange()})});const t=document.getElementById("clearFilters");t&&t.addEventListener("click",()=>{e.clear()});const s=document.getElementById("selectAllFilters");s&&s.addEventListener("click",()=>{e.selectAll()})},selectAll(){const e=C.getTopLevel();this.selectedDepts=[...e],this.selectedPaths=this.selectedDepts.map(t=>[t]),this.render(),this.onFilterChange&&this.onFilterChange()},clear(){this.selectedDepts=[],this.selectedPaths=[],this.render(),this.onFilterChange&&this.onFilterChange()},refresh(){this.render()}},R={icons:{tasks:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 11l3 3L22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
        </svg>`,miniTasks:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="8" y1="6" x2="21" y2="6"/>
            <line x1="8" y1="12" x2="21" y2="12"/>
            <line x1="8" y1="18" x2="21" y2="18"/>
            <circle cx="4" cy="6" r="1.5" fill="currentColor"/>
            <circle cx="4" cy="12" r="1.5" fill="currentColor"/>
            <circle cx="4" cy="18" r="1.5" fill="currentColor"/>
        </svg>`,time:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
        </svg>`},generateSparklinePath(e){if(!e.some(l=>l>0))return{line:"M 2 22 L 68 22",fill:"M 2 22 L 68 22 L 68 24 L 2 24 Z"};const a=e.map((l,c)=>{const h=2+c*66/(e.length-1),m=22-l/100*(24-2*2);return{x:h,y:m}});let o=`M ${a[0].x} ${a[0].y}`;for(let l=1;l<a.length;l++){const c=(a[l-1].x+a[l].x)/2;o+=` Q ${a[l-1].x} ${a[l-1].y}, ${c} ${(a[l-1].y+a[l].y)/2}`}o+=` T ${a[a.length-1].x} ${a[a.length-1].y}`;const r=o+` L ${a[a.length-1].x} 24  L ${a[0].x} 24 Z`;return{line:o,fill:r}},render(){const e=document.getElementById("analyticsContainer");if(!e)return;const t=p.getAnalyticsForWeek(),{byHierarchy:s,miniTasks:n,tasks:i,duration:a}=t,o=Object.entries(s);if(o.length===0){e.innerHTML=`
                <div class="analytics-empty">
                    <div class="empty-state-illustration">
                        <svg viewBox="0 0 200 140" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Background decorations -->
                            <circle class="float-shape s1" cx="25" cy="30" r="6" fill="url(#aGrad1)" opacity="0.3"/>
                            <circle class="float-shape s2" cx="175" cy="25" r="5" fill="url(#aGrad2)" opacity="0.4"/>
                            
                            <!-- Chart bars -->
                            <g transform="translate(40, 20)">
                                <rect x="0" y="60" width="20" height="50" rx="4" fill="url(#aGrad1)" opacity="0.4"/>
                                <rect x="30" y="40" width="20" height="70" rx="4" fill="url(#aGrad1)" opacity="0.5"/>
                                <rect x="60" y="20" width="20" height="90" rx="4" fill="url(#aGrad1)" opacity="0.6"/>
                                <rect x="90" y="50" width="20" height="60" rx="4" fill="url(#aGrad1)" opacity="0.45"/>
                                
                                <!-- Baseline -->
                                <line x1="0" y1="110" x2="110" y2="110" stroke="#475569" stroke-width="2" stroke-linecap="round"/>
                            </g>
                            
                            <!-- Sparkle -->
                            <path class="sparkle" d="M160 60 L162 65 L167 67 L162 69 L160 74 L158 69 L153 67 L158 65 Z" fill="#fbbf24"/>
                            
                            <!-- Gradients -->
                            <defs>
                                <linearGradient id="aGrad1" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" stop-color="#3b82f6"/>
                                    <stop offset="100%" stop-color="#8b5cf6"/>
                                </linearGradient>
                                <linearGradient id="aGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#10b981"/>
                                    <stop offset="100%" stop-color="#06b6d4"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <p class="empty-state-title">No scheduled tasks</p>
                    <p class="empty-state-subtitle">Schedule tasks to see your analytics</p>
                </div>
            `;return}const r=o.reduce((u,[,f])=>u+f.total,0),l=i.total>0?Math.round(i.completed/i.total*100):0,c=n.total>0?Math.round(n.completed/n.total*100):0,h=p.getDailyStatsForWeek(),m=this.generateSparklinePath(h.map(u=>u.tasks.percent)),g=this.generateSparklinePath(h.map(u=>u.miniTasks.percent));e.innerHTML=`
            <div class="analytics-stats-grid">
                <div class="analytics-stat-card ring-card">
                    <div class="progress-ring-container">
                        <svg class="progress-ring" viewBox="0 0 80 80">
                            <circle class="progress-ring-bg" cx="40" cy="40" r="32" />
                            <circle class="progress-ring-fill tasks" cx="40" cy="40" r="32" 
                                stroke-dasharray="201" 
                                stroke-dashoffset="${201-201*l/100}" />
                        </svg>
                        <div class="progress-ring-value">${l}%</div>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">${i.completed}<span class="stat-total">/${i.total}</span></div>
                        <div class="stat-label">Tasks Done</div>
                        <div class="sparkline-container">
                            <svg class="sparkline" viewBox="0 0 70 24" preserveAspectRatio="none">
                                <defs>
                                    <linearGradient id="sparkGradTasks" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" stop-color="#10b981" stop-opacity="0.3"/>
                                        <stop offset="100%" stop-color="#10b981" stop-opacity="0"/>
                                    </linearGradient>
                                </defs>
                                <path class="sparkline-fill" d="${m.fill}" fill="url(#sparkGradTasks)"/>
                                <path class="sparkline-line tasks" d="${m.line}" fill="none" stroke="#10b981" stroke-width="1.5"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-stat-card ring-card">
                    <div class="progress-ring-container">
                        <svg class="progress-ring" viewBox="0 0 80 80">
                            <circle class="progress-ring-bg" cx="40" cy="40" r="32" />
                            <circle class="progress-ring-fill mini" cx="40" cy="40" r="32" 
                                stroke-dasharray="201" 
                                stroke-dashoffset="${201-201*c/100}" />
                        </svg>
                        <div class="progress-ring-value">${c}%</div>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">${n.completed}<span class="stat-total">/${n.total}</span></div>
                        <div class="stat-label">Mini-Tasks</div>
                        <div class="sparkline-container">
                            <svg class="sparkline" viewBox="0 0 70 24" preserveAspectRatio="none">
                                <defs>
                                    <linearGradient id="sparkGradMini" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" stop-color="#a855f7" stop-opacity="0.3"/>
                                        <stop offset="100%" stop-color="#a855f7" stop-opacity="0"/>
                                    </linearGradient>
                                </defs>
                                <path class="sparkline-fill" d="${g.fill}" fill="url(#sparkGradMini)"/>
                                <path class="sparkline-line mini" d="${g.line}" fill="none" stroke="#a855f7" stroke-width="1.5"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-stat-card time-card">
                    <div class="stat-icon stat-icon-time">${this.icons.time}</div>
                    <div class="stat-content">
                        <div class="stat-value">${b.formatDuration(a.total)}</div>
                        <div class="stat-label">Total Time</div>
                    </div>
                </div>
            </div>
            
            <div class="analytics-header">
                <h3>Time by Department</h3>
            </div>
            <div class="analytics-chart">
                ${o.map(([u,{total:f,completed:y}])=>{const v=C.getColor([u]),T=Math.round(f/r*100),S=Math.round(y/f*100);return`
                        <div class="analytics-bar-container">
                            <div class="analytics-bar-label">
                                <span class="analytics-dept" style="color: ${v};">${u}</span>
                                <span class="analytics-value">${b.formatDuration(f)} (${T}%)</span>
                            </div>
                            <div class="analytics-bar-wrapper">
                                <div class="analytics-bar" style="width: ${T}%; background-color: ${v};">
                                    <div class="analytics-bar-completed" style="width: ${S}%;"></div>
                                </div>
                            </div>
                        </div>
                    `}).join("")}
            </div>
        `}},A={searchTerm:"",onEditTask:null,init(){this.render(),this.setupTabs(),this.setupSearch(),p.subscribe(()=>{console.log("TaskQueue: Store updated, refreshing UI..."),this.refresh()})},setupSearch(){const e=document.getElementById("taskSearchInput"),t=document.getElementById("searchClearBtn");e&&(e.addEventListener("input",s=>{this.searchTerm=s.target.value.toLowerCase(),this.render()}),t&&t.addEventListener("click",()=>{e.value="",this.searchTerm="",this.render(),e.focus()}))},setupTabs(){const e=document.querySelectorAll(".sidebar-tab"),t=document.getElementById("queuePanel"),s=document.getElementById("analyticsPanel"),n=document.getElementById("filtersPanel"),i=document.getElementById("sidebarSearch");e.forEach(a=>{a.addEventListener("click",()=>{e.forEach(r=>r.classList.remove("active")),a.classList.add("active");const o=a.dataset.tab;t.style.display=o==="queue"?"block":"none",s.style.display=o==="analytics"?"block":"none",n.style.display=o==="filters"?"block":"none",i.style.display=o==="queue"?"block":"none",o==="analytics"&&R&&R.render(),o==="filters"&&E&&E.refresh()})})},render(){const e=document.getElementById("taskQueue");let t=p.getQueueTasks();const s=E?E.selectedPaths:[];if((E||this.searchTerm)&&(t=t.filter(n=>this.searchTerm&&!n.title.toLowerCase().includes(this.searchTerm)?!1:E&&E.selectedPaths?E.selectedPaths.length===0?!0:E.selectedPaths.some(i=>{if(!n.hierarchy||n.hierarchy.length===0)return!0;for(let a=0;a<i.length;a++)if(n.hierarchy[a]!==i[a])return!1;return!0}):!0)),t.length===0){const n=s.length>0;e.innerHTML=`
        <div class="task-queue-empty">
          <div class="empty-state-illustration">
            <svg viewBox="0 0 200 160" fill="none" xmlns="http://www.w3.org/2000/svg">
              <!-- Floating shapes background -->
              <circle class="float-shape s1" cx="30" cy="40" r="8" fill="url(#grad1)" opacity="0.3"/>
              <circle class="float-shape s2" cx="170" cy="30" r="6" fill="url(#grad2)" opacity="0.4"/>
              <rect class="float-shape s3" x="150" y="100" width="12" height="12" rx="3" fill="url(#grad1)" opacity="0.3" transform="rotate(15 156 106)"/>
              <circle class="float-shape s4" cx="25" cy="120" r="5" fill="url(#grad2)" opacity="0.35"/>
              
              <!-- Main illustration - stylized inbox/clipboard -->
              <g transform="translate(50, 20)">
                <!-- Paper stack -->
                <rect x="8" y="12" width="84" height="100" rx="8" fill="#1e293b" stroke="url(#grad1)" stroke-width="1.5"/>
                <rect x="4" y="8" width="84" height="100" rx="8" fill="#1e3a5f" stroke="url(#grad1)" stroke-width="1.5"/>
                <rect x="0" y="4" width="84" height="100" rx="8" fill="url(#cardGrad)" stroke="url(#grad1)" stroke-width="2"/>
                
                <!-- Decorative lines on paper -->
                <line x1="16" y1="30" x2="68" y2="30" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" opacity="0.5"/>
                <line x1="16" y1="45" x2="52" y2="45" stroke="#6366f1" stroke-width="2" stroke-linecap="round" opacity="0.4"/>
                <line x1="16" y1="60" x2="60" y2="60" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round" opacity="0.3"/>
                
                <!-- Checkmark circle -->
                <circle cx="42" cy="80" r="14" fill="none" stroke="#10b981" stroke-width="2" stroke-dasharray="4 3" opacity="0.6"/>
              </g>
              
              <!-- Sparkle -->
              <path class="sparkle" d="M160 70 L162 75 L167 77 L162 79 L160 84 L158 79 L153 77 L158 75 Z" fill="#fbbf24"/>
              
              <!-- Gradients -->
              <defs>
                <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="#3b82f6"/>
                  <stop offset="100%" stop-color="#8b5cf6"/>
                </linearGradient>
                <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="#10b981"/>
                  <stop offset="100%" stop-color="#06b6d4"/>
                </linearGradient>
                <linearGradient id="cardGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="#1e3a5f"/>
                  <stop offset="100%" stop-color="#0f172a"/>
                </linearGradient>
              </defs>
            </svg>
          </div>
          <p class="empty-state-title">${n?"No tasks match filters":"Your queue is empty"}</p>
          <p class="empty-state-subtitle">${n?"Try adjusting your department filters":'Press N or click "New Task" to get started'}</p>
        </div>
      `;return}e.innerHTML="",t.forEach(n=>{const a=new z(n).render({isDayView:!1,isCompact:!1});a.draggable=!1,e.appendChild(a)}),e.querySelectorAll(".task-block").forEach(n=>{const i=n.dataset.taskId,a=n.querySelector(".task-delete");n.addEventListener("dblclick",o=>{o.stopPropagation(),this.onEditTask&&this.onEditTask(i)}),n.addEventListener("contextmenu",o=>{o.preventDefault(),o.stopPropagation();const r=p.getTask(i),l=r?r.completed:!1,c=p.advanceTaskProgress(i),h=c?c.task:null;if(!l&&h&&h.completed&&window.Confetti){const m=n.getBoundingClientRect(),g=m.left+m.width/2,u=m.top+m.height/2;window.Confetti.burst(g,u,40)}this.refresh(),window.Calendar&&window.Calendar.renderScheduledTasks()}),a&&a.addEventListener("click",async o=>{o.preventDefault(),o.stopPropagation(),console.log("Delete button clicked for task:",i),await H.show("Are you sure you want to delete this task?")?(console.log("User confirmed delete"),p.deleteTask(i)):console.log("User canceled delete")})})},refresh(){this.render()}},j={draggedTask:null,draggedElement:null,dayTasksCache:{},lastHoverCell:null,lastHoverQueue:null,isDraggingTask:!1,hitTestCache:null,dropIndicatorEl:null,lastIndicatorKey:"",getCellFromPointerEvent(e){if(!e||!Number.isFinite(e.clientX)||!Number.isFinite(e.clientY)||e.clientX===0&&e.clientY===0)return null;if(this.hitTestCache)return this.getCellFromHitTestCache(e.clientX,e.clientY);const t=typeof document<"u"?document.elementFromPoint(e.clientX,e.clientY):null;if(t?.closest?.(".time-column")||e.target?.closest?.(".time-column"))return null;const s=t?.closest?.(".day-column")||e.target?.closest?.(".day-column");if(!s)return null;const n=s.querySelectorAll(".calendar-cell");if(!n.length)return null;const i=n[0].getBoundingClientRect(),a=n[0].offsetHeight||b.CELL_HEIGHT,o=Math.floor((e.clientY-i.top)/a),r=Math.min(Math.max(0,o),n.length-1);return n[r]||null},ensureDropIndicator(){if(this.dropIndicatorEl)return this.dropIndicatorEl;const e=document.createElement("div");return e.className="drop-indicator",e.style.display="none",this.dropIndicatorEl=e,e},hideDropIndicator(){this.dropIndicatorEl&&(this.dropIndicatorEl.style.display="none",this.dropIndicatorEl.classList.remove("invalid"),this.lastIndicatorKey="")},showDropIndicator(e,t,s,n){const i=this.ensureDropIndicator();if(!e){this.hideDropIndicator();return}const a=this.hitTestCache?.columnsByEl?.get(e),o=a?.cellHeight||b.CELL_HEIGHT,r=t*o+1,l=Math.max(0,s*o-2),c=`${a?.day||e.dataset.day}|${r}|${l}|${n?"ok":"bad"}`;this.lastIndicatorKey!==c?(i.parentElement!==e&&e.appendChild(i),i.style.top=`${r}px`,i.style.height=`${l}px`,i.classList.toggle("invalid",!n),i.style.display="block",this.lastIndicatorKey=c):i.style.display!=="block"&&(i.style.display="block")},prepareHitTestCache(){if(this.hitTestCache)return;const e=document.getElementById("calendarGrid"),s=(e?.querySelector?.(".time-column")||document.querySelector(".time-column"))?.getBoundingClientRect?.(),n=[],i=new Map;document.querySelectorAll(".day-column").forEach(l=>{const c=l.querySelector(".calendar-cell");if(!c)return;const h=l.getBoundingClientRect(),m=c.getBoundingClientRect(),g=c.offsetHeight||b.CELL_HEIGHT,u=l.querySelectorAll(".calendar-cell"),f=u.length,y={el:l,day:l.dataset.day||"",left:h.left,right:h.right,firstCellTop:m.top,cellHeight:g,cellCount:f,cells:u};n.push(y),i.set(l,y)});const a=()=>{n.forEach(l=>{const c=l.el.querySelector(".calendar-cell");c&&(l.firstCellTop=c.getBoundingClientRect().top,l.cellHeight=c.offsetHeight||l.cellHeight)})};let o=!1;const r=()=>{o||(o=!0,requestAnimationFrame(()=>{o=!1,a()}))};e&&e.addEventListener("scroll",r,{passive:!0}),this.hitTestCache={grid:e,columns:n,columnsByEl:i,timeColumnRight:s?s.right:0,onScroll:r}},clearHitTestCache(){const e=this.hitTestCache;e&&(e.grid&&e.onScroll&&e.grid.removeEventListener("scroll",e.onScroll),this.hitTestCache=null)},getCellFromHitTestCache(e,t){const s=this.hitTestCache;if(!s||s.timeColumnRight&&e<s.timeColumnRight)return null;let n=null;for(const r of s.columns)if(e>=r.left&&e<r.right){n=r;break}if(!n)return null;const i=Math.floor((t-n.firstCellTop)/n.cellHeight),a=Math.min(Math.max(0,i),n.cellCount-1);return!Number.isFinite(a)||a<0?null:n.cells?.[a]||null},getSlotIndexFromTime(e){if(!e)return null;const[t,s]=e.split(":"),n=Number(t),i=Number(s);if(!Number.isFinite(n)||!Number.isFinite(i))return null;const a=60/b.SLOT_DURATION,o=n-b.START_HOUR,r=Math.floor(i/b.SLOT_DURATION),l=o*a+r;return Number.isFinite(l)?l:null},getTimeFromSlotIndex(e){if(!Number.isFinite(e))return null;const t=e*b.SLOT_DURATION,s=b.START_HOUR*60+t,n=Math.floor(s/60),i=s%60,a=String(n).padStart(2,"0"),o=String(i).padStart(2,"0");return`${a}:${o}`},findNearestAvailableStart(e,t,s,n){const i=this.getSlotIndexFromTime(t);if(i===null)return null;const r=(document.getElementById("calendarGrid")?.querySelector?.(`.day-column[data-day="${e}"]`)||document.querySelector(`.day-column[data-day="${e}"]`))?.querySelectorAll?.(".calendar-cell")?.length??0;if(!r)return null;const l=Math.ceil(s/b.SLOT_DURATION),c=Math.max(0,r-l),h=Math.min(Math.max(0,i),c),m=u=>{const f=this.getTimeFromSlotIndex(u);return f&&this.isSlotAvailable(e,f,s,n)?f:null};let g=m(h);if(g)return g;for(let u=1;u<=c;u++){const f=h-u;if(f>=0&&(g=m(f),g))return g;const y=h+u;if(y<=c&&(g=m(y),g))return g}return null},init(){this.setupDragEvents()},setupDragEvents(){let e=null,t=0,s=0,n=null,i=!1,a=null,o=0,r=0,l=!1,c=0,h=0,m=0;document.addEventListener("pointerdown",u=>{if(u.button!==0)return;const f=u.target?.closest?.(".task-block");if(!f)return;const y=!!f.closest(".calendar-task"),v=!!f.closest("#taskQueue");if(!y&&!v||u.target?.closest?.(".task-delete")||u.target?.closest?.("input, textarea, select, button")||u.detail&&u.detail>1)return;const T=f.dataset.taskId;if(!p.getTask(T))return;const x=f.getBoundingClientRect();o=u.clientX-x.left,r=u.clientY-x.top,e={taskId:T,taskBlock:f},t=u.clientX,s=u.clientY,n=u.pointerId,i=!1,l=!1},{capture:!0}),document.addEventListener("pointermove",u=>{if(!e||n!==u.pointerId)return;const f=u.clientX-t,y=u.clientY-s,v=f*f+y*y>=144;if(!i){if(!v)return;try{e.taskBlock.setPointerCapture(n)}catch{}i=!0,this.isDraggingTask=!0,document.body.classList.add("dnd-active"),this.dayTasksCache={},this.lastHoverCell=null,this.lastHoverQueue=null,this.prepareHitTestCache(),this.ensureDropIndicator();const k=p.getTask(e.taskId);this.draggedTask=k,this.draggedElement=e.taskBlock,this.draggedElement.classList.add("dragging");const w=e.taskBlock.cloneNode(!0);w.classList.add("drag-ghost"),w.style.zIndex="9999",w.style.top="0",w.style.left="0",w.style.margin="0",w.style.opacity="0.9",this.draggedElement.style.opacity="0",this.draggedElement.style.pointerEvents="none";const D=e.taskBlock.getBoundingClientRect(),M=D.width,$=D.height;w.style.width=M+"px",w.style.height=$+"px",w.style.maxHeight=$+"px",w.style.minHeight=$+"px",w.style.maxWidth=M+"px";const N=u.clientX-o,Y=u.clientY-r;w.style.transform=`translate3d(${N}px, ${Y}px, 0)`,w.style.left="0",w.style.top="0",w.style.pointerEvents="none",document.body.appendChild(w),a=w,l||(l=!0,document.addEventListener("contextmenu",_=>_.preventDefault(),{once:!0,capture:!0}))}i&&u.preventDefault();const T=document.elementFromPoint(u.clientX,u.clientY),S=T?.closest?.("#taskQueue")||T?.closest?.("#queuePanel")||T?.closest?.(".sidebar"),x=this.getCellFromPointerEvent(u);if(a){if(window.getSelection){const k=window.getSelection();k.removeAllRanges?k.removeAllRanges():k.empty&&k.empty()}h=u.clientX,m=u.clientY,c||(c=requestAnimationFrame(()=>{if(c=0,!a)return;const k=h-o,w=m-r;a.style.transform=`translate3d(${k}px, ${w}px, 0)`}))}if(x){this.lastHoverCell=x,this.lastHoverQueue=null,this.highlightDropZone(x);const k=document.getElementById("taskQueue");k&&k.classList.remove("drag-over")}if(S){this.lastHoverQueue=S,this.lastHoverCell=null,this.hideDropIndicator();const k=document.getElementById("taskQueue");k&&k.classList.add("drag-over")}if(!x&&!S){this.lastHoverCell?this.highlightDropZone(this.lastHoverCell):this.hideDropIndicator();const k=document.getElementById("taskQueue");k&&k.classList.remove("drag-over")}},{capture:!0});const g=u=>{if(!e||n!==u.pointerId)return;const f=()=>{c&&(cancelAnimationFrame(c),c=0),a&&(a.remove(),a=null),document.body.classList.remove("dnd-active"),this.hideDropIndicator(),this.clearHitTestCache(),this.draggedElement?(this.draggedElement.classList.remove("dragging"),this.draggedElement.style.opacity="",this.draggedElement.style.pointerEvents=""):e&&e.taskBlock&&(e.taskBlock.style.opacity="",e.taskBlock.style.pointerEvents="")};if(i&&this.draggedTask&&this.draggedElement){const y=document.elementFromPoint(u.clientX,u.clientY);let v=this.getCellFromPointerEvent(u),T=y?.closest?.("#taskQueue")||y?.closest?.("#queuePanel")||y?.closest?.(".sidebar");!v&&!T&&(this.lastHoverCell?v=this.lastHoverCell:this.lastHoverQueue&&(T=this.lastHoverQueue));const S=this.draggedTask.id,x=this.draggedTask.duration,k=v?.dataset?.day||null,w=v?.dataset?.time||null;if(f(),T)p.unscheduleTask(S,!0);else if(k&&w){this.dayTasksCache={};const D=this.findNearestAvailableStart(k,w,x,S);D&&p.rescheduleTaskInWeek(S,k,D)}I&&typeof I.refresh=="function"&&I.refresh(),A&&typeof A.refresh=="function"&&A.refresh(),R&&typeof R.render=="function"&&R.render()}else f();e=null,n=null,i=!1,this.draggedTask=null,this.draggedElement=null,this.dayTasksCache={},this.lastHoverCell=null,this.lastHoverQueue=null,this.isDraggingTask=!1};document.addEventListener("pointerup",g,{capture:!0}),document.addEventListener("pointercancel",g,{capture:!0})},isSlotAvailable(e,t,s,n=null){this.dayTasksCache[e]||(this.dayTasksCache[e]=p.getTasksForDay(e));const i=this.dayTasksCache[e];return b.isSlotAvailable(t,s,i,n)},highlightDropZone(e){if(!this.draggedTask)return;const t=e.dataset.day,s=e.dataset.time,n=e.closest(".day-column"),i=this.getSlotIndexFromTime(s);if(i===null){this.hideDropIndicator();return}const o=this.hitTestCache?.columnsByEl?.get(n)?.cellCount??n?.querySelectorAll?.(".calendar-cell")?.length??0,r=Math.ceil(this.draggedTask.duration/b.SLOT_DURATION),l=Math.max(0,Math.min(r,o-i)),h=i+r<=o&&this.isSlotAvailable(t,s,this.draggedTask.duration,this.draggedTask.id);this.showDropIndicator(n,i,l,h)}},L={isOpen:!1,activeTaskId:null,activeKeyHandler:null,activeTaskId:null,activeKeyHandler:null,sessionInterval:null,resizeHandler:null,positionRaf:null,carouselAnimating:!1,lastDoneStepIndex:null,sessionDuration:25*60,closureThreshold:5*60,open(e){const t=p.getTask(e);t&&(this.activeTaskId=e,this.isOpen=!0,this.initializeExecutionState(t),this.render(t),document.body.style.overflow="hidden")},initializeExecutionState(e){const t=p.getState().activeExecution;if(t.taskId!==this.activeTaskId){t.taskId=this.activeTaskId,t.running=!1,t.phase="orientation",t.mode="work",t.sessionStartTime=null,t.accumulatedTime=0,t.breakStartTime=null,t.returnAnchor=e.returnAnchor||"";const s=(e.notes||"").split(`
`).filter(n=>n.trim()!=="");t.currentStepIndex=s.findIndex(n=>n.includes("[ ]")),t.currentStepIndex===-1&&s.length>0&&(t.currentStepIndex=0),this.lastDoneStepIndex=null}},close(){this.isOpen=!1,p.getState().activeExecution.running?this.openFloatingTimer():(this.stopSession(),this.activeTaskId=null),this.activeKeyHandler&&(document.removeEventListener("keydown",this.activeKeyHandler),this.activeKeyHandler=null),this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null);const t=document.getElementById("focusModeContainer");t.innerHTML="",document.body.style.overflow="",window.Calendar&&window.Calendar.renderScheduledTasks(),window.TaskQueue&&window.TaskQueue.refresh()},render(e){const t=document.getElementById("focusModeContainer"),s=C.getColor(e.hierarchy),n=p.getState().activeExecution;t.innerHTML=`
            <div class="focus-overlay phase-${n.phase}" id="focusOverlay">
                <div class="focus-card glass-surface-deep" style="--task-color: ${s}">
                    <button class="focus-close" id="closeFocus">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>

                    <!-- Task title at top-left -->
                    <div class="focus-header-topleft">
                        <span class="focus-title" id="focusTaskTitle">${b.escapeHtml(e.title)}</span>
                    </div>

                    <!-- Center: Focus Engine & Quest Stack -->
                    <div class="focus-engine-side">
                        <div class="execution-rings-container">
                            <svg class="execution-ring-svg" viewBox="0 0 120 120" style="position: absolute; width: 100%; height: 100%; transform: rotate(-90deg);">
                                <defs>
                                    <linearGradient id="outerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" stop-color="var(--task-color)" stop-opacity="0.4" />
                                        <stop offset="100%" stop-color="var(--task-color)" stop-opacity="1" />
                                    </linearGradient>
                                    <linearGradient id="innerGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" stop-color="white" />
                                        <stop offset="100%" stop-color="var(--task-color)" />
                                    </linearGradient>
                                    <filter id="innerGlow">
                                        <feGaussianBlur stdDeviation="2" result="blur" />
                                        <feComposite in="SourceGraphic" in2="blur" operator="over" />
                                    </filter>
                                </defs>
                                <circle class="outer-ring-bg" cx="60" cy="60" r="56"/>
                                <circle class="outer-ring-fill" id="outerRing" cx="60" cy="60" r="56" stroke="url(#outerGradient)"/>
                                <circle class="inner-ring-bg" cx="60" cy="60" r="48"/>
                                <circle class="inner-ring-fill" id="innerRing" cx="60" cy="60" r="48" stroke="url(#innerGradient)"/>
                            </svg>
                            <div class="ring-center">
                                <div class="ring-step-title" id="activeStepTitle">
                                    ${n.mode==="work"?this.getActiveStepTitle?this.getActiveStepTitle(e,n.currentStepIndex):"Loading step...":"Coffee & Recharge"}
                                </div>
                                <div class="ring-time" id="sessionTimeDisplay">00:00</div>
                                <div class="ring-media-controls" aria-label="Focus controls">
                                    <button class="ring-media-btn ring-media-primary ${n.running?"running":""}" id="sessionToggleBtn" aria-label="${n.running?"Pause":(n.accumulatedTime||0)>0?"Resume":"Start Focus"}" title="${n.running?"Pause":(n.accumulatedTime||0)>0?"Resume":"Start Focus"}">
                                        ${n.running?`
                                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                        `:`
                                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                                        `}
                                    </button>
                                    ${n.running?`
                                        <button class="ring-media-btn ring-media-stop" id="stopSessionBtn" aria-label="Stop" title="Stop">
                                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
                                        </button>
                                    `:""}
                                </div>
                            </div>
                            ${n.phase==="decision"?this.renderDecisionOverlay():""}
                        </div>

                        <!-- Quest Stack Moved Under Controls -->
                        <div class="quest-stack-container" id="questStack">
                            ${this.renderQuestStack(e,n.currentStepIndex)}
                            <button class="step-action-btn complete-btn carousel-complete-btn" id="carouselCompleteBtn" title="Mark step complete (Enter)">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                                Complete
                            </button>
                            <div class="carousel-nav" id="carouselNav" aria-label="Step navigation">
                                <button class="carousel-nav-btn" id="carouselNavUpBtn" title="Previous step (â†‘)" aria-label="Previous step">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 5l-7 7h14l-7-7z"/>
                                    </svg>
                                </button>
                                <button class="carousel-nav-btn" id="carouselNavDownBtn" title="Next step (â†“)" aria-label="Next step">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 19l7-7H5l7 7z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,this.setupListeners(),this.updateRings(),this.updateTimeDisplay(),this.startSessionInterval(),this.schedulePositionCarouselCompleteButton();const i=document.querySelector("#questStack .quest-carousel");requestAnimationFrame(()=>{i?.classList.remove("no-initial-transition"),this.schedulePositionCarouselCompleteButton()})},renderDecisionOverlay(){return`
            <div class="decision-overlay">
                <div class="decision-title">Session Complete</div>
                <div class="decision-grid">
                    <button class="decision-btn primary" id="decisionComplete">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 6L9 17l-5-5"/>
                        </svg>
                        Mark step complete
                    </button>
                    <button class="decision-btn" id="decisionContinue">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Continue this step
                    </button>
                    <button class="decision-btn" id="decisionModify">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Modify / Split step
                    </button>
                </div>
            </div>
        `},getActiveStepTitle(e,t){if(!e.notes)return"Define your first step";const s=e.notes.split(`
`).filter(n=>n.trim()!=="");return s.length===0?"Define your first step":t<0||t>=s.length?s[0].replace(/\[[ x]\]\s*/,"").trim():s[t].replace(/\[[ x]\]\s*/,"").trim()},updateQuestStack(){const e=p.getTask(this.activeTaskId),t=p.getState().activeExecution,s=document.getElementById("questStack"),n=document.getElementById("activeStepTitle");if(s){const i=s.querySelector(".quest-carousel");if(i)this.carouselAnimating||this.syncCarousel(i,e,t.currentStepIndex);else{s.innerHTML=this.renderQuestStack(e,t.currentStepIndex),this.ensureCarouselCompleteButton(s),this.ensureCarouselNav(s),this.setupCarouselListeners(s);const a=s.querySelector(".quest-carousel");requestAnimationFrame(()=>{a?.classList.remove("no-initial-transition"),this.schedulePositionCarouselCompleteButton()})}}n&&(n.textContent=this.getActiveStepTitle(e,t.currentStepIndex)),this.schedulePositionCarouselCompleteButton()},schedulePositionCarouselCompleteButton(){this.positionRaf&&cancelAnimationFrame(this.positionRaf),this.positionRaf=requestAnimationFrame(()=>{this.positionRaf=null,this.positionCarouselCompleteButton(),this.positionCarouselNav()})},ensureCarouselCompleteButton(e){if(!e||e.querySelector("#carouselCompleteBtn"))return;const t=document.createElement("button");t.className="step-action-btn complete-btn carousel-complete-btn",t.id="carouselCompleteBtn",t.title="Mark step complete (Enter)",t.innerHTML=`
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/>
            </svg>
            Complete
        `,e.appendChild(t)},ensureCarouselNav(e){if(!e||e.querySelector("#carouselNav"))return;const t=document.createElement("div");t.className="carousel-nav",t.id="carouselNav",t.setAttribute("aria-label","Step navigation"),t.innerHTML=`
            <button class="carousel-nav-btn" id="carouselNavUpBtn" title="Previous step (â†‘)" aria-label="Previous step">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5l-7 7h14l-7-7z"/>
                </svg>
            </button>
            <button class="carousel-nav-btn" id="carouselNavDownBtn" title="Next step (â†“)" aria-label="Next step">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19l7-7H5l7 7z"/>
                </svg>
            </button>
        `,e.appendChild(t)},positionCarouselCompleteButton(){const e=document.getElementById("questStack"),t=document.getElementById("carouselCompleteBtn");if(!e||!t)return;const s=e.querySelector(".quest-carousel"),n=s?.querySelector(".carousel-card.active");if(!s||!n){t.classList.add("hidden");return}const i=e.getBoundingClientRect(),a=n.getBoundingClientRect();if(!i.width||!i.height||!a.width||!a.height){t.classList.add("hidden");return}const o=e.offsetWidth?i.width/e.offsetWidth:1,r=e.offsetHeight?i.height/e.offsetHeight:1,l=(a.left-i.left)/o,c=(a.top-i.top)/r,h=a.width/o,m=a.height/r,g=window.matchMedia("(max-width: 520px)").matches,u=16;if(t.classList.remove("hidden"),g){const f=Math.max(0,h-u*2);t.style.width=`${f}px`,t.style.setProperty("--complete-tx","-50%"),t.style.setProperty("--complete-ty","-100%"),t.style.setProperty("--complete-x",`${l+h/2}px`),t.style.setProperty("--complete-y",`${c+m-u}px`)}else t.style.width="",t.style.setProperty("--complete-tx","-100%"),t.style.setProperty("--complete-ty","-100%"),t.style.setProperty("--complete-x",`${l+h-u}px`),t.style.setProperty("--complete-y",`${c+m-u}px`)},positionCarouselNav(){const e=document.getElementById("questStack"),t=document.getElementById("carouselNav");if(!e||!t)return;const s=e.querySelector(".quest-carousel"),n=s?.querySelector(".carousel-card.active");if(!s||!n){t.classList.add("hidden");return}const i=e.getBoundingClientRect(),a=n.getBoundingClientRect();if(!i.width||!i.height||!a.width||!a.height){t.classList.add("hidden");return}const o=e.offsetWidth?i.width/e.offsetWidth:1,r=e.offsetHeight?i.height/e.offsetHeight:1,l=(a.left-i.left)/o,c=(a.top-i.top)/r,h=a.width/o,m=a.height/r,g=window.matchMedia("(max-width: 520px)").matches,u=g?10:14,f=36,y=g?8:10;t.classList.remove("hidden"),t.style.setProperty("--nav-tx","0%"),t.style.setProperty("--nav-ty","-50%");const v=l+h+u,T=Math.max(y,Math.min(v,e.offsetWidth-f-y));t.style.setProperty("--nav-x",`${T}px`),t.style.setProperty("--nav-y",`${c+m/2}px`)},setupCarouselListeners(e){const t=e.querySelector(".quest-carousel");t&&t.dataset.listenersAttached!=="true"&&(t.dataset.listenersAttached="true",t.addEventListener("click",s=>{const n=s.target.closest(".carousel-card");if(!n||n.classList.contains("empty"))return;const i=p.getState().activeExecution;if(i.phase==="execution")return;const a=parseInt(n.dataset.index);Number.isNaN(a)||a<0||(i.currentStepIndex=a,this.lastDoneStepIndex=null,this.updateQuestStack())}))},getNextIncompleteIndex(e,t){return e.findIndex((s,n)=>n>t&&s.includes("[ ]"))},getPrevCompletedIndex(e,t){for(let s=t-1;s>=0;s--)if(e[s]?.includes("[x]"))return s;return-1},buildCarouselCardInnerHtml(e,t,s){const n=e==="below"?"done":e,i=t>=0?`Step ${t+1}`:"",a=n==="active"?'<div class="carousel-icon active">â—</div>':n==="done"?'<div class="carousel-icon done">âœ“</div>':'<div class="carousel-icon upcoming">â—‹</div>',o=n==="active"?'<div class="carousel-badge">NOW</div>':"",r=`<div class="carousel-text">${b.escapeHtml(s)}</div>`;return`
            <div class="carousel-header">
                ${a}
                <div class="carousel-step">${i}</div>
                ${o}
            </div>
            ${r}
        `},fillCarouselCard(e,t,s,n){if(e.classList.remove("active","upcoming","done","behind","below","empty","sliding-down","sliding-to-active","sliding-behind-to-upcoming","sliding-out","sliding-done-to-active","sliding-active-to-upcoming","sliding-upcoming-to-behind","sliding-below-to-done"),e.classList.add(t),s===-1){e.classList.add("empty"),e.dataset.index="-1",e.style.setProperty("--depth",1),e.innerHTML="";return}const a=(n[s]||"").replace(/\[[ x]\]\s*/,"").trim(),o=t==="active"?0:t==="behind"||t==="below"?2:1;e.dataset.index=String(s),e.style.setProperty("--depth",o),e.innerHTML=this.buildCarouselCardInnerHtml(t,s,a)},syncCarousel(e,t,s){const n=(t.notes||"").split(`
`).filter(m=>m.trim()!=="");if(n.length===0)return;const i=e.querySelector('.carousel-card[data-role="done"]'),a=e.querySelector('.carousel-card[data-role="active"]'),o=e.querySelector('.carousel-card[data-role="upcoming"]'),r=e.querySelector('.carousel-card[data-role="behind"]');if(!i||!a||!o||!r)return;const l=this.getNextIncompleteIndex(n,s),c=l===-1?-1:this.getNextIncompleteIndex(n,l),h=this.lastDoneStepIndex!==null&&this.lastDoneStepIndex>=0&&this.lastDoneStepIndex<s?this.lastDoneStepIndex:this.getPrevCompletedIndex(n,s);this.fillCarouselCard(i,"done",h,n),this.fillCarouselCard(a,"active",s,n),this.fillCarouselCard(o,"upcoming",l,n),this.fillCarouselCard(r,"behind",c,n)},animateCarouselRoll(e,{markComplete:t}){if(this.carouselAnimating)return;const s=p.getTask(this.activeTaskId),n=p.getState().activeExecution,i=n.currentStepIndex;if(e===-1||e===i)return;const o=document.getElementById("questStack")?.querySelector(".quest-carousel");if(!o)return;const r=o.querySelector('.carousel-card[data-role="done"]'),l=o.querySelector('.carousel-card[data-role="active"]'),c=o.querySelector('.carousel-card[data-role="upcoming"]'),h=o.querySelector('.carousel-card[data-role="behind"]');if(!r||!l||!c||!h)return;const m=(s.notes||"").split(`
`).filter(y=>y.trim()!==""),g=this.getNextIncompleteIndex(m,e);this.fillCarouselCard(c,"upcoming",e,m),this.fillCarouselCard(h,"behind",g,m),t&&this.toggleMiniTask(i,!0),this.carouselAnimating=!0,o.classList.add("carousel-rolling"),document.getElementById("carouselCompleteBtn")?.classList.add("hidden"),document.getElementById("carouselNav")?.classList.add("hidden"),r.classList.add("sliding-out"),l.classList.add("sliding-down"),c.classList.add("sliding-to-active"),h.classList.add("sliding-behind-to-upcoming"),o.offsetHeight;const u=()=>{this.lastDoneStepIndex=i,n.currentStepIndex=e;const y=p.getTask(this.activeTaskId),v=(y.notes||"").split(`
`).filter($=>$.trim()!==""),T=g,S=T===-1?-1:this.getNextIncompleteIndex(v,T),x=r,k=l,w=c,D=h;x.dataset.role="behind",D.dataset.role="upcoming",w.dataset.role="active",k.dataset.role="done",this.fillCarouselCard(k,"done",i,v),this.fillCarouselCard(w,"active",e,v),this.fillCarouselCard(D,"upcoming",T,v),this.fillCarouselCard(x,"behind",S,v);const M=document.getElementById("activeStepTitle");M&&(M.textContent=this.getActiveStepTitle(y,n.currentStepIndex)),this.updateRings(),o.classList.remove("carousel-rolling"),this.carouselAnimating=!1,this.schedulePositionCarouselCompleteButton()},f=y=>{y.animationName==="rollToActive"&&u()};c.addEventListener("animationend",f,{once:!0})},animateCarouselRollReverse(e){if(this.carouselAnimating)return;const t=p.getTask(this.activeTaskId),s=p.getState().activeExecution,n=s.currentStepIndex;if(e===-1||e===n)return;const a=document.getElementById("questStack")?.querySelector(".quest-carousel");if(!a)return;const o=a.querySelector('.carousel-card[data-role="done"]'),r=a.querySelector('.carousel-card[data-role="active"]'),l=a.querySelector('.carousel-card[data-role="upcoming"]'),c=a.querySelector('.carousel-card[data-role="behind"]');if(!o||!r||!l||!c)return;const h=parseInt(l.dataset.index),m=(t.notes||"").split(`
`).filter(y=>y.trim()!==""),g=this.getPrevCompletedIndex(m,e);this.fillCarouselCard(c,"below",g,m),this.carouselAnimating=!0,a.classList.add("carousel-rolling"),document.getElementById("carouselCompleteBtn")?.classList.add("hidden"),document.getElementById("carouselNav")?.classList.add("hidden"),o.classList.add("sliding-done-to-active"),r.classList.add("sliding-active-to-upcoming"),l.classList.add("sliding-upcoming-to-behind"),c.classList.add("sliding-below-to-done"),a.offsetHeight;const u=()=>{s.currentStepIndex=e,this.lastDoneStepIndex=null;const y=p.getTask(this.activeTaskId),v=(y.notes||"").split(`
`).filter(N=>N.trim()!==""),T=this.getPrevCompletedIndex(v,e),S=n,x=!Number.isNaN(h)&&h>=0?h:this.getNextIncompleteIndex(v,S),k=o,w=r,D=l,M=c;k.dataset.role="active",w.dataset.role="upcoming",D.dataset.role="behind",M.dataset.role="done",this.fillCarouselCard(k,"active",e,v),this.fillCarouselCard(w,"upcoming",S,v),this.fillCarouselCard(D,"behind",x,v),this.fillCarouselCard(M,"done",T,v);const $=document.getElementById("activeStepTitle");$&&($.textContent=this.getActiveStepTitle(y,s.currentStepIndex)),this.updateRings(),a.classList.remove("carousel-rolling"),this.carouselAnimating=!1,this.schedulePositionCarouselCompleteButton()},f=y=>{y.animationName==="rollDoneToActive"&&u()};o.addEventListener("animationend",f,{once:!0})},renderQuestStack(e,t){const s=e.notes||"";if(!s)return'<div class="pills-empty">Define your journey steps...</div>';const n=s.split(`
`).filter(m=>m.trim()!=="");if(n.length===0)return'<div class="pills-empty">Define your journey steps...</div>';const i=this.getNextIncompleteIndex(n,t),a=i===-1?-1:this.getNextIncompleteIndex(n,i),o=this.lastDoneStepIndex!==null&&this.lastDoneStepIndex>=0&&this.lastDoneStepIndex<t?this.lastDoneStepIndex:this.getPrevCompletedIndex(n,t),r=o===-1?"":this.buildCarouselCardInnerHtml("done",o,n[o].replace(/\[[ x]\]\s*/,"").trim()),l=this.buildCarouselCardInnerHtml("active",t,n[t].replace(/\[[ x]\]\s*/,"").trim()),c=i===-1?"":this.buildCarouselCardInnerHtml("upcoming",i,n[i].replace(/\[[ x]\]\s*/,"").trim()),h=a===-1?"":this.buildCarouselCardInnerHtml("behind",a,n[a].replace(/\[[ x]\]\s*/,"").trim());return`
            <div class="quest-carousel no-initial-transition" data-carousel="drum">
                <div class="carousel-card done ${o===-1?"empty":""}" data-role="done" data-index="${o}" style="--depth: 1;">${r}</div>
                <div class="carousel-card active" data-role="active" data-index="${t}" style="--depth: 0;">${l}</div>
                <div class="carousel-card upcoming ${i===-1?"empty":""}" data-role="upcoming" data-index="${i}" style="--depth: 1;">${c}</div>
                <div class="carousel-card behind ${a===-1?"empty":""}" data-role="behind" data-index="${a}" style="--depth: 2;">${h}</div>
            </div>
        `},setupListeners(){const e=document.getElementById("focusOverlay"),t=document.getElementById("closeFocus"),s=document.getElementById("sessionToggleBtn"),n=document.querySelectorAll(".carousel-card");e?.addEventListener("click",i=>{i.target===e&&this.close()}),t?.addEventListener("click",()=>this.close()),s?.addEventListener("click",()=>{p.getState().activeExecution.running?this.pauseSession():this.startSession(),this.render(p.getTask(this.activeTaskId))}),document.getElementById("stopSessionBtn")?.addEventListener("click",()=>{this.stopSession()}),document.getElementById("decisionComplete")?.addEventListener("click",()=>this.handleDecision("complete")),document.getElementById("decisionContinue")?.addEventListener("click",()=>this.handleDecision("continue")),document.getElementById("decisionModify")?.addEventListener("click",()=>this.handleDecision("modify")),document.getElementById("carouselNavUpBtn")?.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.navigateToPrevVisibleStep()}),document.getElementById("carouselNavDownBtn")?.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.skipToNextStep()}),document.getElementById("carouselCompleteBtn")?.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.completeCurrentStep()}),n.forEach(i=>{i.addEventListener("mousemove",a=>{const o=i.getBoundingClientRect(),r=(a.clientX-o.left)/o.width*100,l=(a.clientY-o.top)/o.height*100;i.style.setProperty("--mouse-x",`${r}%`),i.style.setProperty("--mouse-y",`${l}%`)})}),this.activeKeyHandler&&document.removeEventListener("keydown",this.activeKeyHandler),this.activeKeyHandler=i=>{if(i.key==="Enter"){if(i.target.tagName==="INPUT"||i.target.tagName==="TEXTAREA"||i.metaKey||i.ctrlKey||i.altKey)return;this.completeCurrentStep();return}if(i.key==="Escape"||i.key.toLowerCase()==="f"){if(i.target.tagName==="INPUT"||i.target.tagName==="TEXTAREA")return;this.close()}},document.addEventListener("keydown",this.activeKeyHandler),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=()=>this.schedulePositionCarouselCompleteButton(),window.addEventListener("resize",this.resizeHandler)},toggleSession(){p.getState().activeExecution.running?this.stopSession():this.startSession(),this.render(p.getTask(this.activeTaskId))},startSession(){const e=p.getState().activeExecution;if((p.getTask(this.activeTaskId).notes||"").split(`
`).filter(n=>n.trim()!=="").length===0){alert("Please define at least one step before starting.");return}e.running=!0,e.phase="execution",e.mode="work",e.sessionStartTime=Date.now(),e.breakStartTime=null,e.updatedAt=Date.now(),this.startSessionInterval()},stopSession(){const e=p.getState().activeExecution;e.running=!1,e.phase="orientation",e.sessionStartTime=null,e.accumulatedTime=0,e.mode="work",e.breakStartTime=null,clearInterval(this.sessionInterval),this.sessionInterval=null},startSessionInterval(){this.sessionInterval&&clearInterval(this.sessionInterval),this.sessionInterval=setInterval(()=>{if(!this.isOpen&&!p.getState().activeExecution.running){clearInterval(this.sessionInterval);return}this.tick()},1e3)},tick(){const e=p.getState().activeExecution;if(!e.running&&e.mode!=="break")return;const t=Date.now();if(e.mode==="work"){const s=e.sessionStartTime?t-e.sessionStartTime:0,n=(e.accumulatedTime||0)+s,i=Math.floor(n/1e3);i>=this.sessionDuration-this.closureThreshold&&e.phase==="execution"&&(e.phase="closure",this.notifyPhaseChange("closure")),i>=this.sessionDuration&&(e.running=!1,e.phase="decision",e.accumulatedTime=0,this.render(p.getTask(this.activeTaskId)))}else e.mode;this.updateRings(),this.updateTimeDisplay()},pauseSession(){const e=p.getState().activeExecution;e.running&&(e.sessionStartTime&&(e.accumulatedTime=(e.accumulatedTime||0)+(Date.now()-e.sessionStartTime)),e.running=!1,e.sessionStartTime=null)},handleDecision(e){const t=p.getState().activeExecution,s=p.getTask(this.activeTaskId);if(e==="complete"){this.toggleMiniTask(t.currentStepIndex);const i=s.notes.split(`
`).filter(a=>a.trim()!=="").findIndex((a,o)=>o>t.currentStepIndex&&a.includes("[ ]"));i!==-1&&(t.currentStepIndex=i)}else if(e!=="modify"){if(e==="continue"){this.startSession();return}}t.phase="orientation",t.running=!1,this.render(p.getTask(this.activeTaskId))},updateRings(){const e=p.getState().activeExecution,t=p.getTask(this.activeTaskId),s=document.getElementById("outerRing"),n=document.getElementById("innerRing");if(!s||!n)return;const i=(t.notes||"").split(`
`).filter(h=>h.trim()!==""),a=i.filter(h=>h.includes("[x]")).length,o=i.length||1,r=2*Math.PI*56,l=a/o;s.style.strokeDasharray=r,s.style.strokeDashoffset=r*(1-l),s.style.opacity=l>0?"1":"0.3";const c=2*Math.PI*48;if(n.style.strokeDasharray=c,e.mode==="work"){const h=e.running&&e.sessionStartTime?Date.now()-e.sessionStartTime:0,m=(e.accumulatedTime||0)+h,g=Math.min(1,m/(this.sessionDuration*1e3));n.style.strokeDashoffset=c*(1-g),n.style.opacity=e.running?"1":"0.5"}else e.mode==="break"?(n.style.strokeDashoffset=0,n.style.opacity="0.2"):(n.style.strokeDashoffset=c,n.style.opacity="0.3")},updateTimeDisplay(){const e=document.getElementById("sessionTimeDisplay");if(!e)return;const t=p.getState().activeExecution;let s=t.accumulatedTime||0;t.mode==="work"&&t.running&&t.sessionStartTime&&(s+=Date.now()-t.sessionStartTime);const n=Math.floor(s/1e3),i=Math.max(0,this.sessionDuration-n),a=Math.floor(i/60),o=i%60;e.textContent=`${a.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},notifyPhaseChange(e){console.log(`[Focus] Phase changed to: ${e}`)},deleteMiniTask(e){const s=p.getTask(this.activeTaskId).notes.split(`
`);s.splice(e,1),p.updateTaskNotesForWeek(this.activeTaskId,s.join(`
`)),this.updateQuestStack(),window.Calendar&&window.Calendar.refresh()},toggleMiniTask(e,t=!1){const n=p.getTask(this.activeTaskId).notes.split(`
`),i=n[e];i.includes("[x]")?n[e]=i.replace("[x]","[ ]"):i.includes("[ ]")?n[e]=i.replace("[ ]","[x]"):n[e]=`[x] ${i}`,p.updateTaskNotesForWeek(this.activeTaskId,n.join(`
`)),t||this.updateQuestStack(),window.Calendar&&window.Calendar.refresh()},goToPreviousStep(){const e=p.getState().activeExecution,s=(p.getTask(this.activeTaskId).notes||"").split(`
`).filter(n=>n.trim()!=="");if(s.length!==0){for(let n=e.currentStepIndex-1;n>=0;n--)if(s[n]!==void 0){e.currentStepIndex=n,this.lastDoneStepIndex=null,this.updateQuestStack();return}}},navigateToPrevVisibleStep(){if(this.carouselAnimating||p.getState().activeExecution.phase==="execution")return;const s=document.getElementById("questStack")?.querySelector(".quest-carousel");if(!s)return;const n=s.querySelector('.carousel-card[data-role="done"]');if(!n||n.classList.contains("empty"))return;const i=parseInt(n.dataset.index);Number.isNaN(i)||i<0||this.animateCarouselRollReverse(i)},skipToNextStep(){const e=p.getState().activeExecution,n=(p.getTask(this.activeTaskId).notes||"").split(`
`).filter(i=>i.trim()!=="").findIndex((i,a)=>a>e.currentStepIndex&&i.includes("[ ]"));n!==-1&&this.animateCarouselRoll(n,{markComplete:!1})},completeCurrentStep(){const e=p.getState().activeExecution,t=p.getTask(this.activeTaskId),s=e.currentStepIndex,i=(t.notes||"").split(`
`).filter(a=>a.trim()!=="").findIndex((a,o)=>o>e.currentStepIndex&&a.includes("[ ]"));if(i!==-1){this.animateCarouselRoll(i,{markComplete:!0});return}this.toggleMiniTask(s,!0),this.lastDoneStepIndex=s,this.updateQuestStack()},formatTime(e){const t=Math.floor(e/60),s=e%60;return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},updateTimerDisplay(){const e=document.getElementById("pomodoroTime"),t=document.getElementById("pomodoroRing"),s=document.getElementById("pomodoroModeLabel");if(!e||!t)return;e.textContent=this.formatTime(this.pomodoroSeconds);const n=327,i=this.pomodoroMode==="work"?this.workDuration:this.breakDuration,a=this.pomodoroSeconds/i,o=n*(1-a);t.style.strokeDasharray=n,t.style.strokeDashoffset=o,this.pomodoroMode==="work"?(s.textContent="ðŸŽ¯ Focus Mode",t.style.stroke="#3b82f6"):(s.textContent="â˜• Break Time",t.style.stroke="#10b981")},startPauseTimer(){const e=document.getElementById("pomodoroStartPause");this.pomodoroRunning?(clearInterval(this.pomodoroTimer),this.pomodoroRunning=!1,e.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5,3 19,12 5,21"/>
            </svg>`,this.pomodoroTargetEpoch=null,this.persistTimerState(),this.updateFloatingTimer()):(this.pomodoroRunning=!0,e.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <rect x="5" y="4" width="4" height="16"/>
                <rect x="15" y="4" width="4" height="16"/>
            </svg>`,this.pomodoroTargetEpoch=Date.now()+this.pomodoroSeconds*1e3,this.pomodoroTimer=setInterval(()=>{const t=Math.max(0,Math.round((this.pomodoroTargetEpoch-Date.now())/1e3));this.pomodoroSeconds=t,this.updateTimerDisplay(),this.updateFloatingTimer(),t<=0&&this.switchMode()},1e3),this.persistTimerState(),this.updateFloatingTimer())},resetTimer(){clearInterval(this.pomodoroTimer),this.pomodoroRunning=!1,this.pomodoroMode="work",this.pomodoroSeconds=this.workDuration,this.pomodoroTargetEpoch=null;const e=document.getElementById("pomodoroStartPause");e&&(e.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5,3 19,12 5,21"/>
            </svg>`),this.updateTimerDisplay(),this.persistTimerState(),this.updateFloatingTimer()},switchMode(){clearInterval(this.pomodoroTimer),this.pomodoroRunning=!1,this.pomodoroMode==="work"?(this.pomodoroMode="break",this.pomodoroSeconds=this.breakDuration,Notification.permission==="granted"&&new Notification("ðŸŽ‰ Focus session complete!",{body:"Time for a break."})):(this.pomodoroMode="work",this.pomodoroSeconds=this.workDuration,Notification.permission==="granted"&&new Notification("ðŸ’ª Break over!",{body:"Ready to focus again?"}));const e=document.getElementById("pomodoroStartPause");e&&(e.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5,3 19,12 5,21"/>
            </svg>`),this.updateTimerDisplay(),this.pomodoroTargetEpoch=null,this.persistTimerState(),this.updateFloatingTimer()},stopTimer(){this.pomodoroTimer&&(clearInterval(this.pomodoroTimer),this.pomodoroTimer=null),this.pomodoroRunning=!1,this.pomodoroTargetEpoch=null,this.persistTimerState(),this.updateFloatingTimer()},persistTimerState(){const e={mode:this.pomodoroMode,running:this.pomodoroRunning,remaining:this.pomodoroSeconds,targetEpoch:this.pomodoroTargetEpoch,work:this.workDuration,break:this.breakDuration,updatedAt:Date.now()};try{localStorage.setItem("focusModeTimerState",JSON.stringify(e))}catch{}},restoreTimerState(){let e=null;try{e=JSON.parse(localStorage.getItem("focusModeTimerState")||"null")}catch{}if(!e){this.pomodoroMode="work",this.pomodoroSeconds=this.workDuration,this.pomodoroRunning=!1,this.pomodoroTargetEpoch=null;return}if(this.workDuration=e.work||this.workDuration,this.breakDuration=e.break||this.breakDuration,this.pomodoroMode=e.mode||"work",e.targetEpoch&&e.running){const t=Math.max(0,Math.round((e.targetEpoch-Date.now())/1e3));this.pomodoroSeconds=t,this.pomodoroRunning=t>0,this.pomodoroTargetEpoch=e.targetEpoch,this.pomodoroRunning&&!this.pomodoroTimer&&(this.pomodoroTimer=setInterval(()=>{const s=Math.max(0,Math.round((this.pomodoroTargetEpoch-Date.now())/1e3));this.pomodoroSeconds=s,this.updateTimerDisplay(),this.updateFloatingTimer(),s<=0&&this.switchMode()},1e3))}else this.pomodoroSeconds=e.remaining||(this.pomodoroMode==="work"?this.workDuration:this.breakDuration),this.pomodoroRunning=!1,this.pomodoroTargetEpoch=null},async openFloatingTimer(){const e=document.documentPictureInPicture;if(!this.pipWindow)try{if(!e)throw new Error("pip");const t=await e.requestWindow({initialWidth:220,initialHeight:160});this.pipWindow=t;const s=t.document;s.body.style.margin="0",s.body.style.fontFamily="system-ui, -apple-system, Segoe UI, Roboto, Arial",s.body.innerHTML=`
                <div id="pipRoot" style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:12px;background:#111;color:#fff;height:100%;box-sizing:border-box;">
                    <div id="pipMode" style="font-size:12px;font-weight:600;opacity:0.8"></div>
                    <div id="pipTime" style="font-size:32px;font-weight:700;letter-spacing:-1px"></div>
                    <div style="display:flex;gap:8px;">
                        <button id="pipStartPause" style="padding:6px 10px;border:none;border-radius:8px;background:#2563eb;color:#fff">Start</button>
                        <button id="pipReset" style="padding:6px 10px;border:1px solid #333;border-radius:8px;background:#222;color:#ddd">Reset</button>
                    </div>
                </div>`,t.startPause=()=>this.startPauseTimer(),t.resetTimer=()=>this.resetTimer(),s.getElementById("pipStartPause").addEventListener("click",()=>t.startPause()),s.getElementById("pipReset").addEventListener("click",()=>t.resetTimer()),t.addEventListener("pagehide",()=>{this.pipWindow=null}),this.updateFloatingTimer(),this.hideBadge()}catch{this.showBadge()}},updateFloatingTimer(){const e=this.pipWindow;if(e){const t=e.document,s=t.getElementById("pipTime"),n=t.getElementById("pipMode"),i=t.getElementById("pipStartPause");s&&n&&i&&(s.textContent=this.formatTime(this.pomodoroSeconds),n.textContent=this.pomodoroMode==="work"?"Focus":"Break",i.textContent=this.pomodoroRunning?"Pause":"Start")}this.updateBadge()},closeFloatingTimer(){if(this.pipWindow){try{this.pipWindow.close()}catch{}this.pipWindow=null}},showBadge(){if(this.badgeEl)return;const e=document.createElement("div");e.id="floatingPomodoroBadge",e.style.position="fixed",e.style.zIndex="9999",e.style.background="#111",e.style.color="#fff",e.style.border="1px solid #333",e.style.borderRadius="12px",e.style.boxShadow="0 6px 20px rgba(0,0,0,0.4)",e.style.padding="10px 12px",e.style.display="flex",e.style.alignItems="center",e.style.gap="10px",e.innerHTML=`
            <span id="badgeMode" style="font-size:12px;opacity:0.8"></span>
            <span id="badgeTime" style="font-size:18px;font-weight:700;letter-spacing:-0.5px"></span>
            <button id="badgeStartPause" style="padding:6px 10px;border:none;border-radius:8px;background:#2563eb;color:#fff;font-size:12px">Start</button>
            <button id="badgeReset" style="padding:6px 10px;border:1px solid #333;border-radius:8px;background:#222;color:#ddd;font-size:12px">Reset</button>
        `,document.body.appendChild(e),this.badgeEl=e;const t=(()=>{try{return JSON.parse(localStorage.getItem("floatingPomodoroBadgePos")||"null")}catch{return null}})();if(t&&typeof t.left=="number"&&typeof t.top=="number")e.style.left=`${t.left}px`,e.style.top=`${t.top}px`;else{const c=Math.max(0,window.innerWidth-e.offsetWidth-16),h=Math.max(0,window.innerHeight-e.offsetHeight-16);e.style.left=`${c}px`,e.style.top=`${h}px`}e.querySelector("#badgeStartPause").addEventListener("click",()=>this.startPauseTimer()),e.querySelector("#badgeReset").addEventListener("click",()=>this.resetTimer());let s=!1,n=0,i=0,a=0,o=0;const r=c=>{if(!s)return;const h=c.clientX-n,m=c.clientY-i,g=Math.min(Math.max(0,a+h),window.innerWidth-e.offsetWidth),u=Math.min(Math.max(0,o+m),window.innerHeight-e.offsetHeight);e.style.left=`${g}px`,e.style.top=`${u}px`},l=()=>{if(s){s=!1,document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",l);try{const c=e.getBoundingClientRect();localStorage.setItem("floatingPomodoroBadgePos",JSON.stringify({left:c.left,top:c.top}))}catch{}}};e.addEventListener("mousedown",c=>{if(c.target&&c.target.tagName==="BUTTON")return;s=!0,n=c.clientX,i=c.clientY;const h=e.getBoundingClientRect();a=h.left,o=h.top,document.addEventListener("mousemove",r),document.addEventListener("mouseup",l)}),this.updateBadge()},updateBadge(){if(!this.badgeEl)return;const e=this.badgeEl.querySelector("#badgeTime"),t=this.badgeEl.querySelector("#badgeMode"),s=this.badgeEl.querySelector("#badgeStartPause");!e||!t||!s||(e.textContent=this.formatTime(this.pomodoroSeconds),t.textContent=this.pomodoroMode==="work"?"Focus":"Break",s.textContent=this.pomodoroRunning?"Pause":"Start",!this.pomodoroRunning&&this.pomodoroSeconds<=0&&this.hideBadge())},hideBadge(){if(this.badgeEl){try{this.badgeEl.remove()}catch{}this.badgeEl=null}}};window.FocusMode=L;const Z={container:null,isVisible:!1,init(){this.createContainer(),this.setupListeners()},createContainer(){const e=document.createElement("div");e.id="updateNotification",e.className="update-notification hidden",e.innerHTML=`
            <div class="update-content">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                <span>A new version is available!</span>
            </div>
            <div class="update-actions">
                <button class="update-btn update-btn-primary" id="updateNowBtn">Update Now</button>
                <button class="update-btn update-btn-secondary" id="dismissUpdateBtn">Later</button>
            </div>
        `,document.body.insertBefore(e,document.body.firstChild),this.container=e,document.getElementById("updateNowBtn").addEventListener("click",()=>{this.applyUpdate()}),document.getElementById("dismissUpdateBtn").addEventListener("click",()=>{this.hide()})},setupListeners(){"serviceWorker"in navigator&&(navigator.serviceWorker.addEventListener("message",e=>{e.data&&e.data.type==="UPDATE_AVAILABLE"&&this.show()}),navigator.serviceWorker.ready.then(e=>{e.waiting&&this.show(),e.addEventListener("updatefound",()=>{const t=e.installing;t.addEventListener("statechange",()=>{t.state==="installed"&&navigator.serviceWorker.controller&&this.show()})})}))},show(){this.isVisible||(this.isVisible=!0,this.container.classList.remove("hidden"),"vibrate"in navigator&&navigator.vibrate(200))},hide(){this.isVisible=!1,this.container.classList.add("hidden")},applyUpdate(){"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.ready.then(e=>{e.waiting&&e.waiting.postMessage({type:"SKIP_WAITING"})}),window.location.reload()}},P={activeElement:null,trapElement:null,boundHandler:null,activate(e){if(!e)return;this.activeElement=document.activeElement,this.trapElement=e;const t=this.getFocusableElements(e);t.length!==0&&(setTimeout(()=>{t[0]?.focus()},50),this.boundHandler=s=>this.handleKeydown(s),e.addEventListener("keydown",this.boundHandler))},deactivate(){this.trapElement&&this.boundHandler&&this.trapElement.removeEventListener("keydown",this.boundHandler),this.activeElement&&typeof this.activeElement.focus=="function"&&setTimeout(()=>{this.activeElement.focus()},50),this.activeElement=null,this.trapElement=null,this.boundHandler=null},handleKeydown(e){if(e.key!=="Tab")return;const t=this.getFocusableElements(this.trapElement);if(t.length===0)return;const s=t[0],n=t[t.length-1];e.shiftKey?document.activeElement===s&&(e.preventDefault(),n.focus()):document.activeElement===n&&(e.preventDefault(),s.focus())},getFocusableElements(e){const t=['button:not([disabled]):not([tabindex="-1"])','input:not([disabled]):not([type="hidden"]):not([tabindex="-1"])','select:not([disabled]):not([tabindex="-1"])','textarea:not([disabled]):not([tabindex="-1"])','a[href]:not([tabindex="-1"])','[tabindex]:not([tabindex="-1"]):not([disabled])'].join(", ");return Array.from(e.querySelectorAll(t)).filter(n=>n.offsetWidth>0&&n.offsetHeight>0)}},Q={isOpen:!1,editingData:null,migrationsPending:[],draggedDept:null,dragOverDept:null,open(){this.isOpen=!0,this.editingData=JSON.parse(JSON.stringify(B)),this.migrationsPending=[],this.render();const e=document.getElementById("departmentSettingsModal");e&&P.activate(e)},close(){this.isOpen=!1,this._escapeHandler&&(document.removeEventListener("keydown",this._escapeHandler),this._escapeHandler=null),P.deactivate();const e=document.getElementById("departmentSettingsModal");e&&e.remove()},save(){this.migrationsPending.forEach(e=>{p.migrateDepartment(e.oldPath,e.newPath)}),p.saveCustomDepartments(this.editingData),J(),this.close(),window.Calendar&&window.Calendar.renderGrid(),window.Filters&&window.Filters.refresh()},render(){const e=document.getElementById("departmentSettingsModal");e&&e.remove();const t=document.createElement("div");t.id="departmentSettingsModal",t.className="dept-settings-modal",t.innerHTML=`
            <div class="dept-settings-overlay" onclick="window.DepartmentSettings.close()"></div>
            <div class="dept-settings-content">
                <div class="dept-settings-header">
                    <h2>Department Settings</h2>
                    <button class="dept-settings-close" onclick="window.DepartmentSettings.close()">Ã—</button>
                </div>
                <div class="dept-settings-body" id="deptSettingsTree">
                    ${this.renderTree()}
                </div>
                <div class="dept-settings-footer">
                    <button class="btn btn-secondary" onclick="window.DepartmentSettings.addDepartment()">
                        ï¼‹ Add Department
                    </button>
                    <div class="dept-settings-actions">
                        <button class="btn btn-ghost" onclick="window.DepartmentSettings.close()">Cancel</button>
                        <button class="btn btn-primary" onclick="window.DepartmentSettings.save()">Save Changes</button>
                    </div>
                </div>
            </div>
        `,document.body.appendChild(t),this._escapeHandler=s=>{s.key==="Escape"&&this.isOpen&&this.close()},document.addEventListener("keydown",this._escapeHandler)},renderTree(){let e="";const t=Object.entries(this.editingData);if(t.length===0)return'<div class="dept-empty-state"><p>No departments yet. Click "+ Add Department" to create one.</p></div>';for(const[s,n]of t)e+=this.renderParentSection(s,n,[s]);return e},renderParentSection(e,t,s){const n=JSON.stringify(s),i=t.children&&Object.keys(t.children).length>0,a=i?Object.keys(t.children).length:0,o=this.dragOverDept===e;let r="";if(i){r='<div class="dept-children">';for(const[l,c]of Object.entries(t.children))r+=this.renderChildNode(l,c,[...s,l]);r+="</div>"}return`
            <div class="dept-section ${o?"drag-over":""}" 
                 data-path='${n}'
                 data-dept-name="${e}"
                 draggable="true"
                 ondragstart="window.DepartmentSettings.handleDragStart(event, '${e}')"
                 ondragend="window.DepartmentSettings.handleDragEnd(event)"
                 ondragover="window.DepartmentSettings.handleDragOver(event, '${e}')"
                 ondragleave="window.DepartmentSettings.handleDragLeave(event)"
                 ondrop="window.DepartmentSettings.handleDrop(event, '${e}')">
                <div class="dept-parent">
                    <span class="dept-drag-handle" title="Drag to reorder">â‹®â‹®</span>
                    <input type="color" class="dept-color-picker" 
                           value="${t.color||"#6366F1"}" 
                           onchange="window.DepartmentSettings.updateColor(${n}, this.value)"
                           title="Click to change color">
                    <span class="dept-badge" style="background: ${t.color||"#6366F1"}">${t.abbr||e.substring(0,2)}</span>
                    <span class="dept-name">${e}</span>
                    ${a>0?`<span class="dept-child-count">${a}</span>`:""}
                    <div class="dept-actions">
                        <button class="dept-action-btn" onclick="window.DepartmentSettings.renameDept(${n})" title="Rename">âœ</button>
                        <button class="dept-action-btn add" onclick="window.DepartmentSettings.addChild(${n})" title="Add sub-department">ï¼‹</button>
                        <button class="dept-action-btn delete" onclick="window.DepartmentSettings.deleteDept(${n})" title="Delete">âœ•</button>
                    </div>
                </div>
                ${r}
            </div>
        `},renderChildNode(e,t,s){const n=JSON.stringify(s),i=this.getParentColor(s),a=t.children&&Object.keys(t.children).length>0;let o="";if(a){o='<div class="dept-subchildren">';for(const[r,l]of Object.entries(t.children))o+=this.renderSubChildNode(r,l,[...s,r]);o+="</div>"}return`
            <div class="dept-child" data-path='${n}'>
                <div class="dept-child-content">
                    <span class="dept-connector"></span>
                    <span class="dept-badge small" style="background: ${i}">${t.abbr||e.substring(0,2)}</span>
                    <span class="dept-name">${e}</span>
                    <div class="dept-actions">
                        <button class="dept-action-btn" onclick="window.DepartmentSettings.renameDept(${n})" title="Rename">âœ</button>
                        <button class="dept-action-btn add" onclick="window.DepartmentSettings.addChild(${n})" title="Add">ï¼‹</button>
                        <button class="dept-action-btn delete" onclick="window.DepartmentSettings.deleteDept(${n})" title="Delete">âœ•</button>
                    </div>
                </div>
                ${o}
            </div>
        `},renderSubChildNode(e,t,s){const n=JSON.stringify(s),i=this.getParentColor(s);return`
            <div class="dept-subchild" data-path='${n}'>
                <span class="dept-connector deep"></span>
                <span class="dept-badge tiny" style="background: ${i}">${t.abbr||e.substring(0,2)}</span>
                <span class="dept-name">${e}</span>
                <div class="dept-actions">
                    <button class="dept-action-btn" onclick="window.DepartmentSettings.renameDept(${n})" title="Rename">âœ</button>
                    <button class="dept-action-btn delete" onclick="window.DepartmentSettings.deleteDept(${n})" title="Delete">âœ•</button>
                </div>
            </div>
        `},getParentColor(e){const t=e[0];return this.editingData[t]?.color||"#666"},addDepartment(){const e=prompt("Enter new department name:");if(!e||e.trim()==="")return;const t=prompt("Enter abbreviation (1-3 letters):",e.substring(0,2).toUpperCase());t&&(this.editingData[e.toUpperCase()]={color:"#6366F1",abbr:t.toUpperCase().substring(0,3),children:{}},this.updateTreeView())},addChild(e){const t=prompt("Enter sub-department name:");if(!t||t.trim()==="")return;const s=prompt("Enter abbreviation (1-3 letters):",t.substring(0,2).toUpperCase());if(!s)return;let n=this.editingData;for(let i=0;i<e.length;i++)i===0?n=n[e[i]]:n=n.children[e[i]];n.children||(n.children={}),n.children[t]={abbr:s.toUpperCase().substring(0,3),children:{}},this.updateTreeView()},renameDept(e){const t=e[e.length-1],s=prompt("Enter new name:",t);if(!s||s.trim()===""||s===t)return;const n=prompt("Enter new abbreviation:",s.substring(0,2).toUpperCase());if(n){if(e.length===1){const i=this.editingData[t],a=s.toUpperCase();delete this.editingData[t],this.editingData[a]={...i,abbr:n.toUpperCase().substring(0,3)},this.migrationsPending.push({oldPath:e,newPath:[a]})}else{let i=this.editingData;for(let o=0;o<e.length-1;o++)o===0?i=i[e[o]]:i=i.children[e[o]];const a=i.children[t];delete i.children[t],i.children[s]={...a,abbr:n.toUpperCase().substring(0,3)},this.migrationsPending.push({oldPath:e,newPath:[...e.slice(0,-1),s]})}this.updateTreeView()}},deleteDept(e){const t=e[e.length-1],s=o=>{if(!o||!o.children)return 0;let r=Object.keys(o.children).length;for(const l of Object.values(o.children))r+=s(l);return r};let n;if(e.length===1)n=this.editingData[e[0]];else{n=this.editingData;for(let o=0;o<e.length;o++)o===0?n=n[e[o]]:n=n.children[e[o]]}const i=s(n);let a=`Delete "${t}"?`;if(i>0&&(a=`Delete "${t}" and ${i} sub-department${i>1?"s":""}?`),!!confirm(a)){if(e.length===1)delete this.editingData[e[0]],this.migrationsPending.push({oldPath:e,newPath:null});else{let o=this.editingData;for(let r=0;r<e.length-1;r++)r===0?o=o[e[r]]:o=o.children[e[r]];delete o.children[e[e.length-1]],this.migrationsPending.push({oldPath:e,newPath:null})}this.updateTreeView()}},updateColor(e,t){e.length===1&&(this.editingData[e[0]].color=t,this.updateTreeView())},updateTreeView(){const e=document.getElementById("deptSettingsTree");e&&(e.innerHTML=this.renderTree())},handleDragStart(e,t){this.draggedDept=t,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",t),setTimeout(()=>{const s=e.target.closest(".dept-section");s&&s.classList.add("dragging")},0)},handleDragEnd(e){this.draggedDept=null,this.dragOverDept=null,document.querySelectorAll(".dept-section").forEach(t=>{t.classList.remove("dragging","drag-over")})},handleDragOver(e,t){e.preventDefault(),e.dataTransfer.dropEffect="move",t!==this.draggedDept&&t!==this.dragOverDept&&(this.dragOverDept=t,document.querySelectorAll(".dept-section").forEach(s=>{s.classList.remove("drag-over"),s.dataset.deptName===t&&s.classList.add("drag-over")}))},handleDragLeave(e){const t=e.relatedTarget;(!t||!e.target.contains(t))&&e.target.classList.remove("drag-over")},handleDrop(e,t){e.preventDefault();const s=this.draggedDept;if(!s||s===t){this.handleDragEnd(e);return}const n=Object.entries(this.editingData),i=n.findIndex(([r])=>r===s),a=n.findIndex(([r])=>r===t);if(i===-1||a===-1){this.handleDragEnd(e);return}const[o]=n.splice(i,1);n.splice(a,0,o),this.editingData=Object.fromEntries(n),this.handleDragEnd(e),this.updateTreeView()}};typeof window<"u"&&(window.DepartmentSettings=Q);const F={isActive:!1,particles:[],canvas:null,ctx:null,animationId:null,colors:["#6366f1","#8b5cf6","#10b981","#f59e0b","#ef4444","#06b6d4","#ec4899","#84cc16"],init(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.id="confettiCanvas",this.canvas.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 2147483647;
        `,document.body.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.resize(),window.addEventListener("resize",()=>this.resize()))},resize(){if(!this.canvas)return;const e=window.devicePixelRatio||1;this.canvas.width=window.innerWidth*e,this.canvas.height=window.innerHeight*e,this.ctx.scale(e,e)},createParticle(e,t){const s=this.colors[Math.floor(Math.random()*this.colors.length)],n=Math.random()*12+6,i=Math.random()>.5?"rect":"circle";return{x:e,y:t,vx:(Math.random()-.5)*20,vy:Math.random()*-20-10,color:s,size:n,shape:i,rotation:Math.random()*360,rotationSpeed:(Math.random()-.5)*15,gravity:.4,friction:.98,opacity:1,decay:.01+Math.random()*.01}},burst(e,t,s=100){this.init();for(let n=0;n<s;n++)this.particles.push(this.createParticle(e,t));this.isActive||(this.isActive=!0,this.animate())},celebrate(){this.init(),console.log("âœ¨ [Confetti] Grand Celebration started!");const e=window.innerWidth,t=window.innerHeight;this.burst(e*.15,t,80),this.burst(e*.5,t,120),this.burst(e*.85,t,80),setTimeout(()=>{this.burst(e*.35,t,70),this.burst(e*.65,t,70)},300),setTimeout(()=>{this.burst(e*.5,t*.4,100)},500),this.playSound()},playSound(){try{const e=window.AudioContext||window.webkitAudioContext;if(!e)return;const t=new e,s=t.createGain();s.connect(t.destination),s.gain.setValueAtTime(.15,t.currentTime);const n=t.createOscillator(),i=t.createGain();n.connect(i),i.connect(s),n.type="sine",n.frequency.setValueAtTime(800,t.currentTime),n.frequency.exponentialRampToValueAtTime(100,t.currentTime+.1),i.gain.setValueAtTime(.5,t.currentTime),i.gain.exponentialRampToValueAtTime(.01,t.currentTime+.1),n.start(),n.stop(t.currentTime+.1),[523.25,659.25,783.99,1046.5,1318.51,1567.98].forEach((c,h)=>{const m=t.createOscillator(),g=t.createGain();m.type="triangle",m.frequency.value=c,m.connect(g),g.connect(s);const u=t.currentTime+h*.08+.05,f=.4;g.gain.setValueAtTime(0,u),g.gain.linearRampToValueAtTime(.2,u+.02),g.gain.exponentialRampToValueAtTime(.001,u+f),m.start(u),m.stop(u+f)}),fetch("./src/assets/sounds/celebration.mp3").then(c=>c.arrayBuffer()).then(c=>t.decodeAudioData(c)).then(c=>{const h=t.createBufferSource();h.buffer=c;const m=t.createGain();m.gain.setValueAtTime(.4,t.currentTime),m.gain.exponentialRampToValueAtTime(.001,t.currentTime+c.duration),h.connect(m),m.connect(s),h.start(t.currentTime)}).catch(c=>console.warn("Could not play celebration MP3:",c));const o=t.createOscillator(),r=t.createGain();o.type="sine",o.frequency.value=3135.96,o.connect(r),r.connect(s);const l=t.currentTime+.5;r.gain.setValueAtTime(0,l),r.gain.linearRampToValueAtTime(.05,l+.05),r.gain.exponentialRampToValueAtTime(.001,l+.3),o.start(l),o.stop(l+.4)}catch{}},animate(){if(!(!this.ctx||!this.canvas)){this.ctx.clearRect(0,0,window.innerWidth,window.innerHeight);for(let e=this.particles.length-1;e>=0;e--){const t=this.particles[e];if(t.vy+=t.gravity,t.vx*=t.friction,t.vy*=t.friction,t.x+=t.vx,t.y+=t.vy,t.rotation+=t.rotationSpeed,t.opacity-=t.decay,t.opacity<=0){this.particles.splice(e,1);continue}this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(t.rotation*Math.PI/180),this.ctx.globalAlpha=t.opacity,this.ctx.fillStyle=t.color,t.shape==="rect"?this.ctx.fillRect(-t.size/2,-t.size/4,t.size,t.size/2):(this.ctx.beginPath(),this.ctx.arc(0,0,t.size/2,0,Math.PI*2),this.ctx.fill()),this.ctx.restore()}this.particles.length>0?this.animationId=requestAnimationFrame(()=>this.animate()):this.isActive=!1}},stop(){this.animationId&&cancelAnimationFrame(this.animationId),this.particles=[],this.isActive=!1,this.ctx&&this.canvas&&this.ctx.clearRect(0,0,window.innerWidth,window.innerHeight)}};typeof window<"u"&&(window.Confetti=F,window.celebrate=()=>F.celebrate(),console.log("ðŸŽŠ Confetti loaded. Type celebrate() in console to trigger manually."));const K={isOpen:!1,open(){this.isOpen=!0,this.render()},close(){this.isOpen=!1;const e=document.getElementById("weeklySummaryContainer");e&&(e.innerHTML="")},getWeeklyStats(){const e=p.getWeekIdentifier(window.Calendar?.currentWeekStart||new Date),t=p.getTasksForWeek(e),s=p.getDailyStatsForWeek(),n=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],i=t.length,a=t.filter(f=>f.completed).length,o=i>0?Math.round(a/i*100):0;let r=0,l=0;t.forEach(f=>{f.scheduledDay&&f.scheduledTime&&(r+=f.duration,f.completed&&(l+=f.duration))});let c=null,h=0;s.forEach((f,y)=>{const v=f.tasks.total,T=f.tasks.completed;if(v>0){const S=T/v,x=c!==null?s[c].tasks.completed:0;(S>h||S===h&&T>x)&&(h=S,c=y)}});let m=0,g=0;t.forEach(f=>{f.notes&&f.notes.split(`
`).forEach(v=>{v.includes("[x]")&&g++,(v.includes("[ ]")||v.includes("[x]"))&&m++})});let u=0;for(let f=s.length-1;f>=0;f--){const y=s[f],v=y.tasks.total,T=y.tasks.completed;if(v>0&&T===v)u++;else if(v>0)break}return{weekId:e,totalTasks:i,completedTasks:a,completionRate:o,totalMinutes:r,completedMinutes:l,bestDay:c!==null?n[c]:null,bestDayRate:Math.round(h*100),totalMiniTasks:m,completedMiniTasks:g,miniTaskRate:m>0?Math.round(g/m*100):0,currentStreak:u,dailyStats:s}},formatDuration(e){if(e<60)return`${e}m`;const t=Math.floor(e/60),s=e%60;return s>0?`${t}h ${s}m`:`${t}h`},generateSparkline(e){const t=e.map(r=>r.tasks.percent),s=Math.max(...t,1),n=200,i=40,a=4,o=t.map((r,l)=>{const c=a+l/(t.length-1)*(n-a*2),h=i-a-r/s*(i-a*2);return`${c},${h}`}).join(" ");return`
            <svg viewBox="0 0 ${n} ${i}" class="summary-sparkline">
                <defs>
                    <linearGradient id="summaryGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stop-color="rgba(99, 102, 241, 0.3)"/>
                        <stop offset="100%" stop-color="rgba(99, 102, 241, 0)"/>
                    </linearGradient>
                </defs>
                <polyline 
                    fill="url(#summaryGrad)" 
                    stroke="none"
                    points="${a},${i-a} ${o} ${n-a},${i-a}"
                />
                <polyline 
                    fill="none" 
                    stroke="#6366f1" 
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    points="${o}"
                />
            </svg>
        `},generateProgressRing(e,t="#6366f1"){const n=2*Math.PI*45,i=n*(1-e/100);return`
            <svg viewBox="0 0 100 100" class="summary-ring">
                <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"/>
                <circle 
                    cx="50" cy="50" r="45" 
                    fill="none" 
                    stroke="${t}" 
                    stroke-width="8"
                    stroke-linecap="round"
                    stroke-dasharray="${n}"
                    stroke-dashoffset="${i}"
                    transform="rotate(-90 50 50)"
                    class="ring-progress"
                />
                <text x="50" y="52" text-anchor="middle" dominant-baseline="middle" class="ring-text">${e}%</text>
            </svg>
        `},render(){const e=document.getElementById("weeklySummaryContainer");if(!e)return;const t=this.getWeeklyStats(),s=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];e.innerHTML=`
            <div class="summary-overlay" id="summaryOverlay">
                <div class="summary-content">
                    <button class="summary-close" id="closeSummary">Ã—</button>
                    
                    <div class="summary-header">
                        <h2>ðŸ“Š Weekly Summary</h2>
                        <span class="summary-week-label">${t.weekId}</span>
                    </div>

                    <div class="summary-body">
                        <!-- Main Progress Ring -->
                        <div class="summary-main-stat">
                            ${this.generateProgressRing(t.completionRate)}
                            <div class="summary-main-label">Task Completion</div>
                        </div>

                        <!-- Quick Stats Grid -->
                        <div class="summary-stats-grid">
                            <div class="summary-stat-card">
                                <span class="stat-value">${t.completedTasks}/${t.totalTasks}</span>
                                <span class="stat-label">Tasks Done</span>
                            </div>
                            <div class="summary-stat-card">
                                <span class="stat-value">${this.formatDuration(t.completedMinutes)}</span>
                                <span class="stat-label">Time Completed</span>
                            </div>
                            <div class="summary-stat-card">
                                <span class="stat-value">${t.completedMiniTasks}/${t.totalMiniTasks}</span>
                                <span class="stat-label">Mini-Tasks</span>
                            </div>
                            <div class="summary-stat-card highlight">
                                <span class="stat-value">${t.currentStreak}</span>
                                <span class="stat-label">Day Streak ðŸ”¥</span>
                            </div>
                        </div>

                        <!-- Daily Breakdown -->
                        <div class="summary-daily">
                            <h4>Daily Breakdown</h4>
                            <div class="daily-bars">
                                ${t.dailyStats.map((n,i)=>`
                                    <div class="daily-bar-item ${t.bestDay===["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][i]?"best":""}">
                                        <div class="daily-bar-fill" style="height: ${n.tasks.percent}%"></div>
                                        <span class="daily-bar-label">${s[i]}</span>
                                        <span class="daily-bar-value">${n.tasks.completed}/${n.tasks.total}</span>
                                    </div>
                                `).join("")}
                            </div>
                        </div>

                        <!-- Best Day Highlight -->
                        ${t.bestDay?`
                            <div class="summary-highlight">
                                <span class="highlight-icon">ðŸ†</span>
                                <span class="highlight-text">Best Day: <strong>${t.bestDay}</strong> (${t.bestDayRate}%)</span>
                            </div>
                        `:""}

                        <!-- Weekly Trend Sparkline -->
                        <div class="summary-trend">
                            <h4>Weekly Trend</h4>
                            ${this.generateSparkline(t.dailyStats)}
                        </div>
                    </div>

                    <div class="summary-footer">
                        <button class="btn btn-secondary" id="closeSummaryBtn">Close</button>
                    </div>
                </div>
            </div>
        `,this.setupListeners()},setupListeners(){const e=document.getElementById("summaryOverlay"),t=document.getElementById("closeSummary"),s=document.getElementById("closeSummaryBtn");e&&e.addEventListener("click",i=>{i.target===e&&this.close()}),t&&t.addEventListener("click",()=>this.close()),s&&s.addEventListener("click",()=>this.close());const n=i=>{i.key==="Escape"&&this.isOpen&&(this.close(),document.removeEventListener("keydown",n))};document.addEventListener("keydown",n)}};typeof window<"u"&&(window.WeeklySummary=K);const V="3.1.0",ee={selectedDuration:60,scheduledData:null,editingTaskId:null,pendingSteps:[],updateScheduleValidation(){const e=document.getElementById("saveTask"),t=document.getElementById("scheduleMaxInfo"),s=document.getElementById("scheduleInfo");if(!e)return;let n,i,a,o=!1;if(this.scheduledData)({day:n,time:i,maxDuration:a}=this.scheduledData);else if(this.editingTaskId){const g=p.getTask(this.editingTaskId);g&&g.scheduledDay&&(n=g.scheduledDay,i=g.scheduledTime,o=!0)}if(!n){e.disabled=!1,e.classList.remove("btn-disabled"),t&&(t.textContent="");return}const r=this.getSelectedDuration(),l=p.getWeekIdentifier(new Date),h=p.getTasksForWeek(l).filter(g=>g.scheduledDay===n&&g.id!==this.editingTaskId),m=b.isSlotAvailable(i,r,h);o&&s&&(s.style.display="block",document.getElementById("scheduleDayDisplay").textContent=n,document.getElementById("scheduleTimeDisplay").textContent=i),m?(e.disabled=!1,e.classList.remove("btn-disabled"),t&&(t.textContent=a?`Max: ${b.formatDuration(a)}`:"Schedule valid",t.style.color="var(--text-secondary)")):(e.disabled=!0,e.classList.add("btn-disabled"),t&&(t.textContent="âš ï¸ Overlaps with another task",t.style.color="var(--danger)"))},init(){try{window.App=this,window.Store=p,window.Calendar=I,window.DragDrop=j,window.Filters=E,window.FocusMode=L,window.Confetti=F,console.log("App initialized successfully"),p.init(),I.onEditTask=e=>this.editTask(e),I.onOpenModalWithSchedule=(e,t,s)=>this.openModalWithSchedule(e,t,s),I.onPlayCompletionAnimation=e=>this.playCompletionAnimation(e),A.onEditTask=e=>this.editTask(e),E.onFilterChange=()=>{I.refresh(),A.refresh()},L.onCelebration=()=>{const e=window.innerWidth,t=window.innerHeight;F.burst(e/2,t/2,60)},L.onDailyCelebration=e=>I.checkDailyCelebration(e),L.onRefresh=()=>I.refresh(),I.init(),A.init(),j.init(),E.init(),this.setupModal(),this.setupForm(),this.setupSidebar(),this.setupTemplateActions(),this.setupPrintActions(),this.setupSettings(),this.setupKeyboardShortcuts(),this.setupDropdowns(),this.updateBadgeCounts(),this.setupFavicon(),this.displayVersion(),L&&typeof L.restoreTimerState=="function"&&(L.restoreTimerState(),L.pomodoroRunning&&!L.isOpen&&L.showBadge()),console.log("[App] Initialization complete")}catch(e){console.error("[App] CRITICAL ERROR DURING INIT:",e),this.handleCriticalError(e)}},handleCriticalError(e){document.body.innerHTML=`
            <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #0f172a; color: white; font-family: sans-serif; text-align: center; padding: 2rem;">
                <h1 style="color: #ef4444; font-size: 2rem; margin-bottom: 1rem;">System Error</h1>
                <p style="color: #94a3b8; max-width: 500px; line-height: 1.6;">The Weekly Planner failed to start. This might be due to corrupted data in your browser's storage.</p>
                <div style="margin: 2rem 0; padding: 1rem; background: #1e293b; border-radius: 8px; text-align: left; font-family: monospace; font-size: 0.8rem; width: 100%; max-width: 600px; overflow: auto; border: 1px solid #334155;">
                    ${e.stack||e.message}
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button onclick="localStorage.clear(); location.reload();" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600;">Clear Data & Reset App</button>
                    <button onclick="location.reload();" style="background: #334155; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600;">Try Reloading</button>
                </div>
            </div>
        `},displayVersion(){const e=document.getElementById("versionBadge");e&&(e.textContent=`v${V}`),console.log(`[App] Weekly Planner v${V}`)},setupFavicon(){const e=document.querySelector("link[rel~='icon']");e&&(e.href=G);const t=document.querySelector("link[rel='apple-touch-icon']");t&&(t.href=G)},setupSidebar(){const e=document.getElementById("sidebar"),t=document.getElementById("sidebarToggle");localStorage.getItem("sidebarCollapsed")==="true"&&e.classList.add("collapsed"),t.addEventListener("click",()=>{e.classList.toggle("collapsed"),localStorage.setItem("sidebarCollapsed",e.classList.contains("collapsed"))})},setupModal(){const e=document.getElementById("taskModal"),t=document.getElementById("newTaskBtn"),s=document.getElementById("closeModal"),n=document.getElementById("cancelTask");e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.setAttribute("aria-labelledby","modalTitle"),t.addEventListener("click",()=>this.openModal()),s.addEventListener("click",()=>this.closeModal()),n.addEventListener("click",()=>this.closeModal()),e.addEventListener("click",i=>{i.target===e&&this.closeModal()}),document.addEventListener("keydown",i=>{i.key==="Escape"&&e.classList.contains("active")&&this.closeModal(),(i.metaKey||i.ctrlKey)&&i.key==="Enter"&&e.classList.contains("active")&&(i.preventDefault(),this.saveTask())})},openModal(){const e=document.getElementById("taskModal");e.classList.add("active"),this.resetForm(),P.activate(e)},editTask(e){const t=p.getTask(e);if(!t)return;this.openModal(),this.editingTaskId=e,this.populateDepartmentLevel(1,C.getTopLevel()),t.hierarchy.forEach((a,o)=>{const r=o+1,l=document.getElementById(`dept${r}`);if(l&&(l.value=a,r<4)){const c=C.getChildren(t.hierarchy.slice(0,r));this.populateDepartmentLevel(r+1,c)}}),this.updateHierarchyPreview();const s=document.getElementById("taskTitle");s&&(s.value=t.title);const n=t.duration.toString();let i=!1;if(document.querySelectorAll(".duration-option").forEach(a=>{a.dataset.duration===n&&(this.onDurationSelect(a),i=!0)}),!i){const a=document.querySelector('.duration-option[data-duration="custom"]');this.onDurationSelect(a),document.getElementById("customMinutes").value=t.duration}document.querySelector(".modal-title").textContent="Edit Task",document.getElementById("saveTask").textContent="Update Task",this.pendingSteps=[],t.notes&&(this.pendingSteps=t.notes.split(`
`).filter(a=>a.trim()!=="")),this.renderStepsList(),this.updateScheduleValidation()},openModalWithSchedule(e,t,s){if(document.getElementById("taskModal").classList.add("active"),this.resetForm(),this.scheduledData={day:e,time:t,maxDuration:s},document.getElementById("scheduleInfo").style.display="block",document.getElementById("scheduleDayDisplay").textContent=e,document.getElementById("scheduleTimeDisplay").textContent=t,document.getElementById("scheduleMaxInfo").textContent=`Max: ${b.formatDuration(s)}`,document.querySelectorAll(".duration-option").forEach(i=>{const a=i.dataset.duration;if(a==="custom")return;parseInt(a)>s&&i.classList.add("disabled")}),s<60){const i=document.querySelector('.duration-option[data-duration="30"]');i&&!i.classList.contains("disabled")&&this.onDurationSelect(i)}document.getElementById("dept1").focus(),this.updateScheduleValidation()},closeModal(){document.getElementById("taskModal").classList.remove("active"),this.resetForm(),P.deactivate()},setupForm(){this.populateDepartmentLevel(1,C.getTopLevel());for(let t=1;t<=4;t++)document.getElementById(`dept${t}`).addEventListener("change",()=>this.onDepartmentChange(t));document.querySelectorAll(".duration-option").forEach(t=>{t.addEventListener("click",()=>this.onDurationSelect(t))}),document.getElementById("saveTask").addEventListener("click",()=>this.saveTask()),this.setupStepsInput();const e=document.getElementById("customMinutes");e&&e.addEventListener("input",()=>{const t=parseInt(e.value||"0"),s=Math.max(15,Math.min(480,isNaN(t)?60:t));t!==s&&(e.value=s),this.updateScheduleValidation()})},setupStepsInput(){const e=document.getElementById("stepInput"),t=document.getElementById("addStepBtn");if(!e||!t)return;const s=()=>{const n=e.value.trim();n&&(this.pendingSteps.push(n),this.renderStepsList(),e.value="",e.focus())};t.addEventListener("click",s),e.addEventListener("keypress",n=>{n.key==="Enter"&&(n.preventDefault(),s())})},renderStepsList(){const e=document.getElementById("stepsList");e&&(e.innerHTML=this.pendingSteps.map((t,s)=>{const n=t.startsWith("[x] "),i=t.replace(/^\[[ x]\]\s*/,"");return`
            <li class="step-item ${n?"completed":""}">
                <span class="step-checkbox ${n?"checked":""}">
                    ${n?'<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7"/></svg>':""}
                </span>
                <span class="step-text">${b.escapeHtml(i)}</span>
                <button type="button" class="step-remove" data-index="${s}">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </li>
        `}).join(""),e.querySelectorAll(".step-remove").forEach(t=>{t.addEventListener("click",()=>{const s=parseInt(t.dataset.index);this.pendingSteps.splice(s,1),this.renderStepsList()})}))},populateDepartmentLevel(e,t){const s=document.getElementById(`dept${e}`),n=document.getElementById(`deptLevel${e}`);if(e>1)if(t.length>0)n.style.display="flex";else{n.style.display="none",s.innerHTML='<option value="">Select</option>';return}const i=e===1?"Select Department":e===2?"Select Sub-Department":e===3?"Select Category":"Select Sub-Category";s.innerHTML=`<option value="">${i}</option>`+t.map(a=>`<option value="${a}">${a}</option>`).join("")},onDepartmentChange(e){const t=[];for(let n=1;n<=e;n++){const i=document.getElementById(`dept${n}`).value;i&&t.push(i)}for(let n=e+1;n<=4;n++)document.getElementById(`deptLevel${n}`).style.display="none",document.getElementById(`dept${n}`).value="";if(e<4){const n=C.getChildren(t);this.populateDepartmentLevel(e+1,n)}this.updateHierarchyPreview();const s=document.getElementById("taskTitle");s&&(s.value=t.length>0?t[t.length-1]:"")},updateHierarchyPreview(){const e=document.getElementById("hierarchyPreview"),t=this.getSelectedHierarchy();if(t.length===0){e.style.display="none";return}e.style.display="flex";const s=C.getColor(t);e.innerHTML=t.map((n,i)=>`
      <span class="hierarchy-path-item" ${i===0?`style="color: ${s};"`:""}>
        ${n}
      </span>
      ${i<t.length-1?'<span class="hierarchy-path-separator">â€º</span>':""}
    `).join("")},getSelectedHierarchy(){const e=[];for(let t=1;t<=4;t++){const s=document.getElementById(`dept${t}`).value;s&&e.push(s)}return e},onDurationSelect(e){if(e.classList.contains("disabled"))return;document.querySelectorAll(".duration-option").forEach(n=>n.classList.remove("selected")),e.classList.add("selected");const t=e.dataset.duration,s=document.getElementById("customDuration");t==="custom"?(s.style.display="flex",this.selectedDuration=null):(s.style.display="none",this.selectedDuration=parseInt(t)),this.updateScheduleValidation()},getSelectedDuration(){if(this.selectedDuration)return this.selectedDuration;const e=document.getElementById("customMinutes"),t=parseInt(e.value);return isNaN(t)?60:Math.max(15,Math.min(480,t))},saveTask(){const e=document.getElementById("stepInput");e&&e.value.trim()&&(this.pendingSteps.push(e.value.trim()),e.value="");const t=this.getSelectedHierarchy(),s=this.getSelectedDuration();if(t.length===0){alert("Please select at least one department level"),document.getElementById("dept1").focus();return}const i=document.getElementById("taskTitle").value.trim()||t[t.length-1];let a="";if(this.pendingSteps.length>0&&(a=this.pendingSteps.map(o=>o.startsWith("[ ] ")||o.startsWith("[x] ")?o:`[ ] ${o}`).join(`
`)),this.editingTaskId){const o=p.getTask(this.editingTaskId);if(o&&o.scheduledDay&&o.scheduledTime&&s!==o.duration){const r=p.getWeekIdentifier(new Date),c=p.getTasksForWeek(r).filter(h=>h.scheduledDay===o.scheduledDay&&h.id!==this.editingTaskId);if(!b.isSlotAvailable(o.scheduledTime,s,c,this.editingTaskId)){alert(`Cannot set duration to ${b.formatDuration(s)} - it would overlap with another task. Please adjust your schedule first.`);return}}p.updateTask(this.editingTaskId,{title:i,hierarchy:t,duration:s,notes:a})}else{const o=p.addTask({title:i,hierarchy:t,duration:s,notes:a});if(this.scheduledData){const r=p.getTasksForDay(this.scheduledData.day);b.isSlotAvailable(this.scheduledData.time,s,r)?p.scheduleTask(o.id,this.scheduledData.day,this.scheduledData.time):alert(`Cannot schedule at ${this.scheduledData.time} for ${b.formatDuration(s)} - it overlaps another task.`),this.scheduledData=null}}this.closeModal(),window.Calendar&&window.Calendar.refresh(),window.TaskQueue&&window.TaskQueue.refresh(),window.Analytics&&window.Analytics.render(),this.updateBadgeCounts()},resetForm(){document.getElementById("taskForm").reset();for(let n=2;n<=4;n++)document.getElementById(`deptLevel${n}`).style.display="none";document.querySelectorAll(".duration-option").forEach(n=>{n.classList.toggle("selected",n.dataset.duration==="60")}),document.getElementById("customDuration").style.display="none",this.selectedDuration=60,document.getElementById("hierarchyPreview").style.display="none",document.getElementById("scheduleInfo").style.display="none",this.scheduledData=null,document.querySelectorAll(".duration-option").forEach(n=>n.classList.remove("disabled"));const e=document.getElementById("saveTask");e&&(e.disabled=!1);const t=document.getElementById("scheduleMaxInfo");t&&(t.textContent=""),this.editingTaskId=null,document.querySelector(".modal-title").textContent="Create New Task",document.getElementById("saveTask").textContent="Create Task",this.pendingSteps=[];const s=document.getElementById("stepsList");s&&(s.innerHTML="")},setupTemplateActions(){const e=document.getElementById("setTemplateBtn"),t=document.getElementById("resetWeekBtn");e&&e.addEventListener("click",()=>{H.show("Set the current week's schedule as the template for all future weeks?",()=>{p.setTemplateFromCurrentWeek();const s=p.getTemplateCount();alert(`Template updated! ${s} tasks will appear in all future weeks.`)})}),t&&t.addEventListener("click",()=>{H.show("Reset this week to the Default Template? Any changes will be lost.",()=>{p.resetWeekToTemplate(),I.refresh(),A.refresh(),alert("Week reset to template.")})})},setupPrintActions(){const e=document.getElementById("printPdfBtn");e&&e.addEventListener("click",()=>{window.print()})},setupSettings(){const e=document.getElementById("settingsBtn");e&&e.addEventListener("click",()=>{Q.open()});const t=document.getElementById("exportDataBtn");t&&t.addEventListener("click",()=>{p.downloadExport()});const s=document.getElementById("importDataBtn"),n=document.getElementById("importFileInput");s&&n&&(s.addEventListener("click",()=>{n.click()}),n.addEventListener("change",async a=>{const o=a.target.files[0];if(!o)return;await H.show("Import will replace ALL existing data. Are you sure you want to continue?")&&(await p.importFromFile(o,!1)?(alert("Data imported successfully!"),I.refresh(),A.refresh(),E.refresh()):alert("Failed to import data. Please check the file format.")),n.value=""}));const i=document.getElementById("weeklySummaryBtn");i&&i.addEventListener("click",()=>{K.open()})},setupDropdowns(){const e=document.getElementById("moreActionsDropdown"),t=document.getElementById("moreActionsBtn"),s=document.getElementById("moreActionsMenu");!e||!t||!s||(t.addEventListener("click",n=>{n.stopPropagation();const i=e.classList.contains("open");e.classList.toggle("open"),t.setAttribute("aria-expanded",!i)}),document.addEventListener("click",n=>{e.contains(n.target)||(e.classList.remove("open"),t.setAttribute("aria-expanded","false"))}),s.querySelectorAll(".dropdown-item").forEach(n=>{n.addEventListener("click",()=>{e.classList.remove("open"),t.setAttribute("aria-expanded","false")})}),document.addEventListener("keydown",n=>{n.key==="Escape"&&e.classList.contains("open")&&(e.classList.remove("open"),t.setAttribute("aria-expanded","false"),t.focus())}))},setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{const t=document.getElementById("taskModal"),s=document.getElementById("shortcutsModal"),n=t.classList.contains("active"),i=s&&s.classList.contains("active"),a=document.activeElement.tagName==="INPUT"||document.activeElement.tagName==="TEXTAREA"||document.activeElement.tagName==="SELECT";if(i&&e.key==="Escape"){e.preventDefault(),this.closeShortcutsModal();return}if(n){e.key==="Enter"&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),this.saveTask());return}if(!(a||i))switch(e.key.toLowerCase()){case"n":e.preventDefault(),this.openModal();break;case"t":e.preventDefault(),I.setCurrentWeek(new Date);break;case"arrowleft":e.preventDefault(),I.currentWeekStart.setDate(I.currentWeekStart.getDate()-7),p.setCurrentWeek(I.currentWeekStart);break;case"arrowright":e.preventDefault(),I.currentWeekStart.setDate(I.currentWeekStart.getDate()+7),p.setCurrentWeek(I.currentWeekStart);break;case"w":e.preventDefault(),I.setViewMode("week"),document.querySelectorAll(".view-btn").forEach(r=>r.classList.remove("active")),document.querySelector('.view-btn[data-view="week"]')?.classList.add("active");break;case"d":e.preventDefault(),I.setViewMode("day"),document.querySelectorAll(".view-btn").forEach(r=>r.classList.remove("active")),document.querySelector('.view-btn[data-view="day"]')?.classList.add("active");break;case" ":if(e.shiftKey){const r=document.querySelector(".calendar-task:hover .task-block");if(r){e.preventDefault();const l=r.dataset.taskId;window.FocusMode&&window.FocusMode.open(l)}}break;case"f":if(window.FocusMode&&window.FocusMode.isOpen)return;e.preventDefault();let o=document.querySelector(".calendar-task:hover .task-block");if(!o&&window.lastClickedTaskId&&(o=document.querySelector(`.task-block[data-task-id="${window.lastClickedTaskId}"]`)),o||(o=document.querySelector(".calendar-task .task-block")),o){const r=o.dataset.taskId;window.FocusMode&&(console.log("Opening focus mode for task:",r),window.FocusMode.open(r))}else console.log("No task found to focus on. Try hovering over a task first.");break;case"?":e.preventDefault(),this.toggleShortcutsModal();break}}),this.setupShortcutsModal()},setupShortcutsModal(){document.getElementById("shortcutsModal");const e=document.getElementById("shortcutsOverlay"),t=document.getElementById("closeShortcuts"),s=document.getElementById("shortcutsBtn");s&&s.addEventListener("click",()=>this.toggleShortcutsModal()),e&&e.addEventListener("click",()=>this.closeShortcutsModal()),t&&t.addEventListener("click",()=>this.closeShortcutsModal())},toggleShortcutsModal(){const e=document.getElementById("shortcutsModal");if(e){const t=e.classList.contains("active");e.classList.toggle("active"),t?P.deactivate():P.activate(e)}},closeShortcutsModal(){const e=document.getElementById("shortcutsModal");e&&(e.classList.remove("active"),P.deactivate())},updateBadgeCounts(){const e=p.getQueueTasks().length;p.getScheduledTasks().length;const t=document.querySelector('.sidebar-tab[data-tab="queue"]');if(t){const s=t.querySelector(".tab-badge");if(s&&s.remove(),e>0){const n=document.createElement("span");n.className="tab-badge",n.textContent=e,t.appendChild(n)}}},playCompletionAnimation(e){e.classList.add("completing");const t=document.createElement("div");t.className="completion-overlay",t.innerHTML=`
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <path d="M5 13l4 4L19 7"/>
            </svg>
        `,e.appendChild(t),setTimeout(()=>{t.remove(),e.classList.remove("completing")},600)}};document.addEventListener("DOMContentLoaded",()=>{if(ee.init(),Z.init(),"serviceWorker"in navigator){const e=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";(window.location.protocol==="https:"||e)&&window.addEventListener("load",()=>{const n=window.location.pathname.replace(/\/[^\/]*$/,"/")+"sw.js";navigator.serviceWorker.register(n).then(i=>{console.log("[App] Service Worker registered at:",n),setInterval(()=>{navigator.onLine&&i.update()},6e4)}).catch(i=>console.log("[App] SW registration failed:",i))})}});
